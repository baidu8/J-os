---
import IphoneWindow from '../components/IphoneWindow.astro';
// è·å–æ•°æ®
const { posts } = Astro.props;

// è‡ªåŠ¨æå–åˆ†ç±»
const categories = posts ? [...new Set(posts.map(post => post.data.category || 'æœªåˆ†ç±»'))] : [];

// åˆ†ç±»å›¾æ ‡æ˜ å°„
const getCategoryIcon = (cat) => {
  const icons = {
    'æŠ€æœ¯': 'ğŸ’»',
    'ç”Ÿæ´»': 'â˜•',
    'æ‘„å½±': 'ğŸ“·',
    'æŠ€æœ¯ç¬”è®°': 'âš¡',
    'æœªåˆ†ç±»': 'ğŸ“'
  };
  return icons[cat] || 'ğŸ“';
};
---

<div class="view-iphone">
  <div class="iphone-statusbar">
    <div id="iphone-clock">00:00</div>
    <div class="dynamic-island"></div>
    <div class="iphone-status-icons">ğŸ“¶ 5G ğŸ”‹</div>
  </div>

  <div class="iphone-home-screen">
    <div class="iphone-grid">
      <div class="iphone-app" onclick="openIphoneWin('iphone-folder')">
        <div class="iphone-folder-icon glass">
          <div class="mini-app-grid">
            <div style="background:#fff"></div><div style="background:#007aff"></div>
            <div style="background:#27c93f"></div><div style="background:#ff9500"></div>
          </div>
        </div>
        <div class="app-label">åšæ–‡å½’æ¡£</div>
      </div>

      {categories.map(cat => (
        <div class="iphone-app category-icon" onclick={`openCategory('${cat}')`}>
          <div class="iphone-icon-box" style="background: linear-gradient(135deg, #666, #333);">
            <span class="emoji">{getCategoryIcon(cat)}</span>
          </div>
          <div class="app-label">{cat}</div>
        </div>
      ))}
      
      <div class="iphone-app" onclick="openIphoneWin('iphone-photos')">
        <div class="iphone-icon-box" style="background: linear-gradient(#54d3ff, #007aff);">ğŸ“·</div>
        <div class="app-label">ç…§ç‰‡</div>
      </div>

      <div class="iphone-app" onclick="openIphoneWin('iphone-settings')">
        <div class="iphone-icon-box" style="background: #fff;">âš™ï¸</div>
        <div class="app-label">è®¾ç½®</div>
      </div>
    </div>
  </div>

  <IphoneWindow id="iphone-folder" title="åšæ–‡å½’æ¡£">
    <div class="iphone-search-bar">
      <div class="search-input-wrapper">
        <span>ğŸ”</span>
        <input 
          type="text" 
          id="iphone-finder-search" 
          placeholder="æœç´¢æ–‡ç« ..." 
          oninput="filterIphonePosts()"
        />
      </div>
    </div>

    <div class="iphone-category-bar">
      <div class="iphone-cat-item active" onclick="filterIphoneByCategory('all', this)">å…¨éƒ¨</div>
      {categories.map(cat => (
        <div class="iphone-cat-item" onclick={`filterIphoneByCategory('${cat}', this)`}>{cat}</div>
      ))}
    </div>

    <div class="iphone-list-group" id="iphone-post-list">
      {posts.map(post => (
        <div 
          class="iphone-list-item" 
          data-category={post.data.category || 'æœªåˆ†ç±»'}
          onclick={`openIphoneWin('iphone-post-${post.id}')`}
        >
          <div class="item-icon">ğŸ“„</div>
          <div class="item-info">
            <div class="item-title">{post.data.title}</div>
            <div class="item-date">{post.data.date}</div>
          </div>
          <div class="item-arrow">ã€‰</div>
        </div>
      ))}
    </div>
  </IphoneWindow>

  {posts.map(post => (
  <IphoneWindow id={`iphone-post-${post.id}`} title="æ­£æ–‡å†…å®¹">
    <div class="iphone-article">
      <h1>{post.data.title}</h1>
      
      <div class="article-meta">
        <span>{post.data.date}</span>
        {post.data.category && <span class="cat-tag">{post.data.category}</span>}
      </div>
      
      <div class="article-body">
        <post.Content /> 
      </div>
    </div>
  </IphoneWindow>
))}

  <IphoneWindow id="iphone-settings" title="ç³»ç»Ÿè®¾ç½®">
    <div class="settings-ui" style="padding: 15px;">
      <div class="setting-item" style="background:#fff; padding:15px; border-radius:10px; margin-bottom:10px;">é£è¡Œæ¨¡å¼ âœˆï¸</div>
      <div class="setting-item" style="background:#fff; padding:15px; border-radius:10px;">æ— çº¿å±€åŸŸç½‘ ğŸ“¶</div>
    </div>
  </IphoneWindow>

  <IphoneWindow id="iphone-photos" title="æ‰€æœ‰ç…§ç‰‡">
    <div class="photo-grid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:5px; padding:5px;">
      <img src="https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=300" style="width:100%; aspect-ratio:1/1; object-fit:cover;" />
      <img src="https://images.unsplash.com/photo-1497215728101-856f4ea42174?w=300" style="width:100%; aspect-ratio:1/1; object-fit:cover;" />
    </div>
  </IphoneWindow>

<IphoneWindow id="iphone-music" title="ç½‘æ˜“äº‘éŸ³ä¹">
  <div class="music-wrapper" style="height: 100%; background: #f5f5f7;">
    <iframe 
      id="music-iframe"
      frameborder="no" 
      border="0" 
      marginwidth="0" 
      marginheight="0" 
      width="100%" 
      height="100%" 
      src="//music.163.com/outchain/player?type=0&id=3778678&auto=0&height=430">
    </iframe>
  </div>
</IphoneWindow>

<IphoneWindow id="iphone-phone" title="ç”µè¯">
  <div class="keypad-container" style="padding: 40px 20px; text-align: center;">
    <div class="phone-number" style="font-size: 32px; margin-bottom: 30px; font-weight: 300;">
      10086
    </div>
    <div class="keypad-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 280px; margin: 0 auto;">
      {[1,2,3,4,5,6,7,8,9,'*',0,'#'].map(num => (
        <div style="width: 70px; height: 70px; background: #e3e3e8; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
          {num}
        </div>
      ))}
    </div>
    <a href="tel:10086" style="display: inline-block; width: 70px; height: 70px; background: #27c93f; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; margin-top: 30px; text-decoration: none;">
      ğŸ“
    </a>
  </div>
</IphoneWindow>
<IphoneWindow id="iphone-mail" title="è”ç³»æˆ‘">
  <div style="padding: 40px 20px; text-align: center;">
    <div style="font-size: 60px; margin-bottom: 20px;">âœ‰ï¸</div>
    <h3>æœ‰é—®é¢˜æƒ³åé¦ˆï¼Ÿ</h3>
    <p style="color: #666; margin-bottom: 30px;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç»™æˆ‘å‘é‚®ä»¶</p>
    <a href="mailto:jxe2131@outlook.com" style="display: block; background: #007aff; color: white; padding: 15px; border-radius: 12px; text-decoration: none; font-weight: 600;">å‘é€é‚®ä»¶</a>
  </div>
</IphoneWindow>
<IphoneWindow id="iphone-safari" title="Safari æµè§ˆå™¨">
  <div class="safari-wrapper">
    <div class="safari-search-section">
      <div class="safari-input-box">
        <span>ğŸ”</span>
        <input 
          type="text" 
          id="safari-search-input" 
          placeholder="æœç´¢æˆ–è¾“å…¥ç½‘ç«™åç§°" 
          onkeydown="if(event.key==='Enter') doSafariSearch()"
        />
        <button onclick="doSafariSearch()" style="color: #007aff; border: none; background: none; font-size: 14px; font-weight: 600;">æœç´¢</button>
      </div>
    </div>
    <div class="safari-favorites">
      <div class="favorite-title">ä¸ªäººæ”¶è—</div>
      <div class="favorite-grid">
        <a href="https://www.baidu.com" target="_blank" class="fav-item">
          <div class="fav-icon" style="background: #fff; color: #2133ed;">B</div>
          <div class="fav-label">ç™¾åº¦</div>
        </a>
        <a href="https://github.com" target="_blank" class="fav-item">
          <div class="fav-icon" style="background: #181717; color: #fff;">G</div>
          <div class="fav-label">GitHub</div>
        </a>
        <a href="https://v.qq.com" target="_blank" class="fav-item">
          <div class="fav-icon" style="background: #ff5c38; color: #fff;">V</div>
          <div class="fav-label">è…¾è®¯è§†é¢‘</div>
        </a>
        <a href="https://www.bilibili.com" target="_blank" class="fav-item">
          <div class="fav-icon" style="background: #fb7299; color: #fff;">B</div>
          <div class="fav-label">Bç«™</div>
        </a>
      </div>
    </div>
  </div>
</IphoneWindow>
  <IphoneWindow id="iphone-phone" title="ç”µè¯">...</IphoneWindow>
  <IphoneWindow id="iphone-safari" title="Safari">...</IphoneWindow>
  <IphoneWindow id="iphone-music" title="ç½‘æ˜“äº‘éŸ³ä¹">...</IphoneWindow>

  <div class="iphone-dock-container">
    <div class="iphone-dock glass">
      <div class="dock-app" onclick="openIphoneWin('iphone-phone')" style="background: linear-gradient(#63f17a, #27c93f);">ğŸ“</div>
      <div class="dock-app" onclick="openIphoneWin('iphone-mail')" style="background: linear-gradient(#63f17a, #27c93f);">ğŸ’¬</div>
      <div class="dock-app" onclick="openIphoneWin('iphone-safari')" style="background: #fff;">ğŸŒ</div>
      <div class="dock-app" onclick="openIphoneWin('iphone-music')" style="background: linear-gradient(#fb5f74, #fa2d48);">ğŸµ</div>
    </div>
  </div>
</div>
<div id="iphone-image-viewer" class="iphone-image-viewer">
  <div class="iphone-viewer-overlay" onclick="closeIphoneImageViewer()"></div>
  
  <img id="iphone-viewer-img" src="" alt="é¢„è§ˆå›¾ç‰‡" onclick="handleIphoneImageClick(event)" />
  
  <div id="iphone-viewer-counter" class="iphone-viewer-counter">1 / 1</div>
  
  <div class="iphone-viewer-hint">ç‚¹å‡»ä¸¤ä¾§åˆ‡æ¢ï¼Œç‚¹å‡»èƒŒæ™¯å…³é—­</div>
</div>
<style>
.iphone-article {
  padding: 20px;
  color: #333;
  line-height: 1.6;
  /* ç¡®ä¿æ–‡ç« å¤ªé•¿æ—¶å¯ä»¥æ»šåŠ¨ */
  height: 100%;
  overflow-y: auto;
}

.iphone-article h1 {
  font-size: 24px;
  margin-bottom: 10px;
  color: #000;
}

.article-meta {
  font-size: 13px;
  color: #8e8e93;
  margin-bottom: 20px;
  border-bottom: 1px solid #eee;
  padding-bottom: 10px;
}

.article-body {
  font-size: 16px;
  word-wrap: break-word;
  padding-bottom: 50px; /* ç•™å‡ºåº•éƒ¨ç©ºé—´ï¼Œé˜²æ­¢è¢«æŒ¡ä½ */
}

/* é’ˆå¯¹ Markdown é‡Œçš„å›¾ç‰‡è¿›è¡Œçº¦æŸï¼Œé˜²æ­¢æ’‘ç ´å¼¹çª— */
.article-body img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin: 15px 0;
}
.iphone-cat-item {
    cursor: pointer;
    transition: all 0.2s ease;
    -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»è“æ¡† */
}

.iphone-cat-item:active {
    transform: scale(0.95); /* ç‚¹å‡»æ—¶å¾®å¼±ç¼©å°æ•ˆæœ */
    background-color: rgba(0,0,0,0.1);
}

.iphone-cat-item.active {
    background-color: #007aff;
    color: white;
    font-weight: 600;
}
.category-icon .icon-box {
    background: linear-gradient(135deg, #afafaf 0%, #5e5e5e 100%); /* æ–‡ä»¶å¤¹è´¨æ„Ÿ */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 30px;
    border-radius: 12px;
    aspect-ratio: 1/1;
  }
  .app-label {
    font-size: 12px;
    color: white;
    margin-top: 5px;
    text-align: center;
  }
.safari-wrapper {
  padding: 20px;
  background: #fff;
  height: 100%;
}

.safari-search-section {
  margin-top: 10px;
  margin-bottom: 30px;
}

.safari-input-box {
  background: #e3e3e8;
  border-radius: 12px;
  padding: 10px 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.safari-input-box input {
  flex: 1;
  border: none;
  background: transparent;
  outline: none;
  font-size: 16px;
}

.favorite-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 15px;
  color: #000;
}

.favorite-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
}

.fav-item {
  text-decoration: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.fav-icon {
  width: 55px;
  height: 55px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  font-weight: bold;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  background: #f2f2f7;
}

.fav-label {
  font-size: 12px;
  color: #333;
}
.iphone-dock-container {
  position: absolute;
  bottom: 0; /* æ”¹ä¸º 0 */
  padding-bottom: 20px; /* ç”¨ padding æ’‘å¼€ */
  /* å¦‚æœæ˜¯çœŸæœºï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ª CSS å˜é‡ */
  padding-bottom: env(safe-area-inset-bottom, 20px); 
  width: 100%;
  display: flex;
  justify-content: center;
}
/* é’ˆå¯¹éŸ³ä¹å’Œæµè§ˆå™¨çª—å£çš„ç‰¹æ®Šä¼˜åŒ– */
#iphone-music .iphone-page-body,
#iphone-safari .iphone-page-body {
  padding: 0 !important; /* æ»¡å±å±•ç¤º */
  overflow: hidden; /* é˜²æ­¢å‡ºç°åŒæ»šåŠ¨æ¡ */
}

iframe {
  display: block;
}
.dock-app {
  width: 55px;
  height: 55px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 30px;
  cursor: pointer;
  transition: transform 0.2s;
  color: #fff; /* è®© Emoji ä»¥å¤–çš„æ–‡å­—/å›¾æ ‡å˜ç™½ */
}

.dock-app:active {
  transform: scale(0.9); /* ç‚¹å‡»æ—¶çš„ç¼©æ”¾åé¦ˆ */
}

/* æµè§ˆå™¨å…¨å±é€‚é… */
#iphone-safari .iphone-page-body {
  padding: 0; /* æµè§ˆå™¨ä¸éœ€è¦å†…è¾¹è· */
  overflow: hidden;
}
.iphone-statusbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0; /* å¿…é¡»ç»™å®½åº¦ */
  height: 44px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 25px;
  color: #fff; /* é»˜è®¤ä¸»å±å¹•æ˜¯ç™½å­— */
  font-weight: 600;
  font-size: 14px;
  z-index: 9999;
  pointer-events: none;
  transition: color 0.3s; /* è®©å˜è‰²å¹³æ»‘ä¸€ç‚¹ */
}
/* è°ƒæ•´è¿”å›æŒ‰é’®å’Œæ ‡é¢˜çš„ä½ç½®ï¼Œç¡®ä¿å®ƒä»¬åœ¨çŠ¶æ€æ ä¸‹æ–¹å±…ä¸­ */
.iphone-page-header button, 
.iphone-title {
  margin-top: 5px; 
}
/* å¼ºåˆ¶æ‰€æœ‰åœ°æ–¹éƒ½ç”¨è¿™ç§ç»†é•¿çš„ Mac/iOS æ»šåŠ¨æ¡ */
:global(*) {
  scrollbar-width: thin;
  scrollbar-color: rgba(0,0,0,0.2) transparent;
}

:global(*::-webkit-scrollbar) {
  width: 5px;
}

:global(*::-webkit-scrollbar-thumb) {
  background: rgba(0,0,0,0.2);
  border-radius: 10px;
}
  /* --- åŸºç¡€å¸ƒå±€ --- */
  .view-iphone {
    height: 100svh;
    position: fixed; top: 0; left: 0; width: 100vw;
    display: flex; flex-direction: column;
    background: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1000') center/cover;
    z-index: 100; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
  }

  .iphone-statusbar {
    position: fixed; /* å˜æˆå›ºå®šå®šä½ */
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 25px;
    color: #000;
    height: 44px; /* iOS æ ‡å‡†é«˜åº¦ */
    font-weight: 600;
    z-index: 9999; /* æ¯”å¼¹çª—çš„ 5000 è¿˜è¦é«˜ */
    pointer-events: none; /* é‡è¦ï¼šé˜²æ­¢çŠ¶æ€æ é®æŒ¡ä¸‹æ–¹æŒ‰é’®çš„ç‚¹å‡» */
  }
 .iphone-title {
    margin-top: 10px; /* ç»™ä¸Šé¢çš„æ—¶é—´ç•™ç‚¹ç©ºä½ */
  }
  /* src/components/IphoneWindow.astro */
  .dynamic-island { width: 100px; height: 25px; background: #000; border-radius: 20px; }
.iphone-home-screen {
/* å¢åŠ é¡¶éƒ¨å†…è¾¹è·ï¼Œç¡®ä¿å›¾æ ‡ä»çŠ¶æ€æ ä¸‹æ–¹å¼€å§‹æ’åˆ— */
  padding: 60px 20px 20px; 
  flex: 1;
  display: flex;
  flex-direction: column;
}
.iphone-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 25px 20px; /* å¢åŠ è¡Œé—´è· */
    align-content: start;
}
  .iphone-app { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
  .iphone-icon-box, .iphone-folder-icon { width: 60px; height: 60px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 30px; }
  .glass { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2); }
  .mini-app-grid { display: grid; grid-template-columns: repeat(2, 20px); gap: 4px; }
  .mini-app-grid div { width: 20px; height: 20px; border-radius: 4px; }
  .app-label { color: white; font-size: 11px; margin-top: 6px; }

  /* --- æœç´¢ä¸åˆ†ç±» --- */
  .iphone-search-bar { padding: 10px 15px; background: #fff; }
  .search-input-wrapper { background: #e3e3e8; border-radius: 10px; padding: 8px 12px; display: flex; align-items: center; gap: 8px; }
  .search-input-wrapper input { border: none; background: transparent; width: 100%; outline: none; font-size: 16px; }

  .iphone-category-bar { display: flex; overflow-x: auto; padding: 10px 15px; gap: 10px; background: #fff; }
  .iphone-category-bar::-webkit-scrollbar { display: none; }
  .iphone-cat-item { padding: 6px 16px; background: #e3e3e8; border-radius: 20px; font-size: 14px; white-space: nowrap; }
  .iphone-cat-item.active { background: #007aff; color: white; }

  /* --- åˆ—è¡¨ä¸æ–‡ç«  --- */
  .iphone-list-group { margin: 15px; background: white; border-radius: 12px; overflow: hidden; }
  .iphone-list-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 0.5px solid #eee; }
  .item-info { flex: 1; margin-left: 10px; }
  .item-title { font-weight: 500; font-size: 16px; color: #000; }
  .item-date { font-size: 12px; color: #888; }

  .iphone-article { padding: 20px; }
  .article-meta { color: #888; margin-bottom: 20px; }
  .article-body { line-height: 1.6; font-size: 17px; }

  /* --- Dock --- */
  .iphone-dock-container { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; padding-bottom: calc(10px + env(safe-area-inset-bottom));}
  .iphone-dock { width: 90%; height: 80px; border-radius: 25px; display: flex; justify-content: space-around; align-items: center; }
  .dock-app { width: 55px; height: 55px; border-radius: 12px; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 28px; }
  
  .iphone-image-viewer {
    position: fixed; inset: 0; z-index: 9999;
    display: none; justify-content: center; align-items: center;
    background: rgba(0, 0, 0, 0.95); /* æ‰‹æœºç«¯èƒŒæ™¯æ›´æ·±ä¸€ç‚¹ï¼Œä¸“æ³¨å†…å®¹ */
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    opacity: 0; transition: opacity 0.3s ease;
  }
  .iphone-image-viewer.active { display: flex; opacity: 1; }

.iphone-viewer-img {
  max-width: 95%;
  max-height: 80%;
  object-fit: contain;
  z-index: 100; /* ç¡®ä¿åœ¨é®ç½©å±‚ä¹‹ä¸Š */
  position: relative;
  transition: transform 0.3s ease, opacity 0.3s ease;
  user-select: none; /* é˜²æ­¢é•¿æŒ‰å¼¹å‡ºèœå•å¹²æ‰°æ»‘åŠ¨ */
  -webkit-user-drag: none;
}

/* ç¡®ä¿é®ç½©å±‚ä¸æ‹¦æˆªå›¾ç‰‡çš„ç‚¹å‡» */
.iphone-viewer-overlay {
  position: absolute;
  inset: 0;
  z-index: 50; /* ä½äºå›¾ç‰‡ */
  background: transparent; /* æˆ–è€…ä½ ä¹‹å‰çš„æ·±è‰²èƒŒæ™¯ */
}
  .iphone-image-viewer.active #iphone-viewer-img { transform: scale(1); }

  .iphone-viewer-counter {
    position: absolute; top: env(safe-area-inset-top, 20px); /* é¿å¼€æ‰‹æœºåˆ˜æµ· */
    color: white; background: rgba(255,255,255,0.1);
    padding: 4px 12px; border-radius: 20px; font-size: 12px; z-index: 20;
  }

  .iphone-viewer-hint {
    position: absolute; bottom: calc(40px + env(safe-area-inset-bottom));
    color: rgba(255,255,255,0.4); font-size: 12px; z-index: 20;
  }
</style>

<script is:inline>
  /**
   * J-OS iPhone æ ¸å¿ƒé€»è¾‘æ•´åˆç‰ˆ (åŒ…å«æ»‘åŠ¨ä¸ç‚¹å‡»åˆ‡æ¢)
   */

  // --- 1. å…¨å±€å˜é‡ ---
  let currentIphoneCategory = 'all';
  let iphoneAlbum = [];
  let iphoneIndex = 0;
  let touchStartX = 0;
  let touchEndX = 0;

  // --- 2. çª—å£ç®¡ç† ---
  window.openIphoneWin = function(id) {
    const el = document.getElementById(id);
    if (el) {
      el.classList.add('active');
      const statusbar = document.querySelector('.iphone-statusbar');
      if (statusbar) statusbar.style.color = '#000';
    }
  };

  window.closeIphoneWin = function(id) {
    const el = document.getElementById(id);
    if (el) {
      el.classList.remove('active');
      const activeWins = document.querySelectorAll('.iphone-window.active');
      if (activeWins.length === 0) {
        const statusbar = document.querySelector('.iphone-statusbar');
        if (statusbar) statusbar.style.color = '#fff';
      }
    }
  };

  // --- 3. è¿‡æ»¤ä¸æœç´¢ ---
  window.filterIphoneByCategory = function(cat, el) {
    currentIphoneCategory = cat;
    document.querySelectorAll('.iphone-cat-item').forEach(item => item.classList.remove('active'));
    if (el) el.classList.add('active');
    window.filterIphonePosts();
  };

  window.openCategory = function(catName) {
    currentIphoneCategory = catName;
    window.filterIphonePosts();
    document.querySelectorAll('.iphone-cat-item').forEach(item => {
      item.classList.toggle('active', item.innerText === catName);
    });
    window.openIphoneWin('iphone-folder'); 
  };

  window.filterIphonePosts = function() {
    const query = document.getElementById('iphone-finder-search')?.value.toLowerCase().trim() || "";
    const items = document.querySelectorAll('#iphone-post-list .iphone-list-item');
    items.forEach(item => {
      const title = item.querySelector('.item-title')?.innerText.toLowerCase() || "";
      const cat = item.getAttribute('data-category') || "";
      const match = (currentIphoneCategory === 'all' || cat === currentIphoneCategory) && title.includes(query);
      item.style.display = match ? 'flex' : 'none';
    });
  };

  // --- 4. å›¾ç‰‡é¢„è§ˆé€»è¾‘ (å«æ»‘åŠ¨ + ç‚¹å‡») ---
  
  // ç›‘å¬æ­£æ–‡å›¾ç‰‡ç‚¹å‡»å¼€å¯é¢„è§ˆ
  document.addEventListener('click', function(e) {
    const article = e.target.closest('.iphone-article');
    const photos = e.target.closest('.photo-grid');
    
    if (e.target.tagName === 'IMG' && (article || photos)) {
      const container = article || photos;
      const imgs = Array.from(container.querySelectorAll('img'));
      iphoneAlbum = imgs.map(img => img.src);
      iphoneIndex = iphoneAlbum.indexOf(e.target.src);
      showIphoneViewer();
    }
  });

  function showIphoneViewer() {
    const v = document.getElementById('iphone-image-viewer');
    if (!v) return;
    updateIphoneUI();
    v.style.display = 'flex';
    setTimeout(() => v.classList.add('active'), 10);
    initSwipeListener(); // åˆå§‹åŒ–æ»‘åŠ¨ç›‘å¬
  }

  function updateIphoneUI() {
    const img = document.getElementById('iphone-viewer-img');
    const counter = document.getElementById('iphone-viewer-counter');
    if (img) img.src = iphoneAlbum[iphoneIndex];
    if (counter) counter.innerText = `${iphoneIndex + 1} / ${iphoneAlbum.length}`;
  }

  // ç‚¹å‡»åŒºåŸŸåˆ¤å®šåˆ‡æ¢
  window.handleIphoneImageClick = function(e) {
    e.stopPropagation(); // é˜²æ­¢è§¦å‘èƒŒæ™¯å…³é—­
    if (iphoneAlbum.length <= 1) {
      closeIphoneImageViewer();
      return;
    }

    const rect = e.target.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const width = rect.width;

    if (x < width * 0.35) {
      changeIphoneImage(-1); // ç‚¹å‡»å·¦ä¾§
    } else if (x > width * 0.65) {
      changeIphoneImage(1);  // ç‚¹å‡»å³ä¾§
    } else {
      closeIphoneImageViewer(); // ç‚¹å‡»ä¸­é—´å…³é—­
    }
  };

  // æ»‘åŠ¨åˆ‡æ¢é€»è¾‘
  function initSwipeListener() {
    const img = document.getElementById('iphone-viewer-img');
    if (!img || img.dataset.swipeLinked) return;

    img.addEventListener('touchstart', e => {
      touchStartX = e.changedTouches[0].screenX;
    }, {passive: true});

    img.addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;
      if (Math.abs(diff) > 50) { // æ»‘åŠ¨é˜ˆå€¼
        changeIphoneImage(diff > 0 ? 1 : -1);
      }
    }, {passive: true});

    img.dataset.swipeLinked = "true"; // é˜²æ­¢é‡å¤ç»‘å®š
  }

  window.changeIphoneImage = function(step) {
    iphoneIndex = (iphoneIndex + step + iphoneAlbum.length) % iphoneAlbum.length;
    const img = document.getElementById('iphone-viewer-img');
    if (img) {
      img.style.opacity = '0';
      setTimeout(() => {
        updateIphoneUI();
        img.style.opacity = '1';
      }, 150);
    }
  };

  window.closeIphoneImageViewer = function() {
    const v = document.getElementById('iphone-image-viewer');
    if (v) {
      v.classList.remove('active');
      setTimeout(() => v.style.display = 'none', 300);
    }
  };

  // --- 5. è¾…åŠ©åŠŸèƒ½ ---
  function updateIphoneClock() {
    const clock = document.getElementById('iphone-clock');
    if (clock) {
      const now = new Date();
      clock.innerText = now.getHours().toString().padStart(2, '0') + ':' + 
                        now.getMinutes().toString().padStart(2, '0');
    }
  }
  setInterval(updateIphoneClock, 1000);
  updateIphoneClock();
</script>