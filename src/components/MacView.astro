---
const { posts, categories = [] } = Astro.props;
import Window from './Window.astro';
---

{posts.map((post) => (
  <Window 
    id={`post-${post.id}`} 
    title={post.data.title} 
    emoji={post.data.emoji || 'ğŸ“„'}
    category={post.data.category}  >
    <div class="post-content">
       <post.Content /> 
    </div>
  </Window>
))}

<div class="view-mac">
  <div class="mac-menubar">
    <div class="menu-left"><b>ï£¿</b> <span onclick="openWin('mac-finder')">è®¿è¾¾</span> æ–‡ä»¶ ç¼–è¾‘ æ˜¾ç¤º å‰å¾€ çª—å£ å¸®åŠ©</div>
    <div id="mac-clock"></div>
  </div>

  <div class="desktop-icons">
    <div class="icon-unit drag-handle" onclick="openWin('mac-finder')">
      <div class="folder-icon">ğŸ“‚</div>
      <span class="icon-label">åšæ–‡</span>
    </div>
  </div>

  <Window id="mac-finder" title="è®¿è¾¾" emoji="ğŸ“‚">
    <div slot="header-right" style="position: absolute; right: 15px;">
      <input type="text" id="finder-search" placeholder="æœç´¢æ–‡ç« ..." oninput="filterPosts()" onmousedown="event.stopPropagation()" style="font-size: 12px; padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd; outline: none; cursor: text;" />
    </div>

    <div class="finder-layout" style="display: flex; height: 100%; width: 100%;">
      <div class="sidebar" style="width: 160px; border-right: 1px solid rgba(0,0,0,0.1); padding: 10px; flex-shrink: 0;">
        <div class="sidebar-item active" onclick="filterByCategory('all', this)">ğŸ“„ å…¨éƒ¨æ–‡ç« </div>
        {categories.map(cat => (
          <div class="sidebar-item" onclick={`filterByCategory('${cat}', this)`}>ğŸ“ {cat}</div>
        ))}
      </div>
      
      <div class="content-grid" id="finder-items" style="flex: 1; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; overflow-y: auto; align-content: start;">
        {posts.map(post => (
          <div class="grid-item post-item" onclick={`openWin('post-${post.id}')`}>
            <div class="file-icon" style="font-size: 40px;">ğŸ“„</div>
            <div class="file-name" style="font-size: 12px; margin-top: 5px;">{post.data.title}</div>
            <div class="file-category" style="display:none">{post.data.category}</div>
          </div>
        ))}
      </div>
    </div>
  </Window>

  <Window id="mac-message" title="æ ‡ç­¾" emoji="ğŸ§­">
    <div style="padding: 40px; text-align: center; width: 100%;">
      <h2>æ¨¡æ‹Ÿæµè§ˆå™¨çª—å£</h2>
      <img src="https://4kwallpapers.com/images/walls/thumbs_3t/6420.jpg"/>
    </div>
  </Window>

  <Window id="mac-safari" title="" emoji="ğŸ§­">
    <div class="safari-full-container">
      <div class="safari-nav-bar">
        <div class="address-capsule">
          <span class="icon">ğŸ”’</span> google.com
        </div>
      </div>
      <div class="google-viewport">
        <div class="google-center-content">
          <div class="google-branding">
            <span style="color: #4285F4">G</span><span style="color: #EA4335">o</span><span style="color: #FBBC05">o</span><span style="color: #4285F4">g</span><span style="color: #34A853">l</span><span style="color: #EA4335">e</span>
          </div>
          <div class="google-search-group">
            <div class="google-search-input-field">
              <span class="prefix-icon">ğŸ”</span>
              <input type="text" id="google-search-input" placeholder="åœ¨ Google ä¸Šæœç´¢..." autocomplete="off" />
              <span class="suffix-icon">ğŸ™ï¸</span>
            </div>
          </div>
          <div class="google-action-btns">
            <button>Google æœç´¢</button>
            <button>æ‰‹æ°”ä¸é”™</button>
          </div>
        </div>
      </div>
    </div>
  </Window>

  <Window id="mac-photos" title="ç›¸å†Œ" emoji="ğŸ–¼ï¸">
    <div class="photos-container">
      <div class="photos-sidebar">
        <div class="sidebar-group">åº“</div>
        <div class="sidebar-item active">ğŸ“¸ æ‰€æœ‰ç…§ç‰‡</div>
        <div class="sidebar-group">æˆ‘çš„æ‘„å½±é›†</div>
        <div id="photos-post-links" class="sidebar-list">
          </div>
      </div>
      
      <div class="photos-main">
        <div class="photos-header">
          <h2>ç²¾é€‰å±•ç¤º</h2>
          <p>ç‚¹å‡»å·¦ä¾§æŸ¥çœ‹å®Œæ•´æ‘„å½±åšæ–‡</p>
        </div>
        <div class="photos-grid">
          <div class="photo-card"><img src="https://github.com/user-attachments/assets/6fc9bc33-9998-48f6-b1b9-cce7e0e05656" /></div>
          <div class="photo-card"><img src="https://github.com/user-attachments/assets/e3a50fd2-1a47-493a-b7d0-e82e2f63ce67" /></div>
          <div class="photo-card"><img src="https://github.com/user-attachments/assets/6b1492e7-9782-448b-89a7-dd0899978307" /></div>
          <div class="photo-card"><img src="https://github.com/user-attachments/assets/6e712a38-0ed2-4011-99af-340b17c46258" /></div>
          <div class="photo-card"><img src="https://github.com/user-attachments/assets/aa8c860b-ac00-438d-b1b5-78c06750a535" /></div>
          <div class="photo-card"><img src="https://github.com/user-attachments/assets/fae013be-b079-4772-8673-887ef9c926a9" /></div>
        </div>
      </div>
    </div>
  </Window>


  <div class="mac-dock-container">
    <div class="mac-dock">
      <div class="dock-item" onclick="openWin('mac-finder')">ğŸ“‚</div>
      <div class="dock-item" onclick="openWin('mac-safari')">ğŸ§­</div>
      <div class="dock-item" onclick="openWin('mac-photos')">ğŸ–¼ï¸</div>
      <div class="dock-item" onclick="openWin('mac-notes')">ğŸ“</div>
      <div class="dock-item" onclick="openWin('mac-message')">ğŸ’¬</div>
    
      <div id="dock-divider" class="dock-divider"></div>
      <div id="min-zone" class="min-zone"></div>
      
      <div class="dock-item trash" onclick="alert('åƒåœ¾æ¡¶æ˜¯ç©ºçš„')">ğŸ—‘ï¸</div> 
    </div>
  </div>

</div>

<div id="mac-image-viewer" class="mac-image-viewer">
  <div class="mac-viewer-overlay" onclick="closeMacViewer()"></div>
  <img id="mac-viewer-img" src="" alt="é¢„è§ˆå›¾ç‰‡" />
  <div class="mac-viewer-toolbar">
    <button onclick="changeMacImage(-1)" title="ä¸Šä¸€å¼  (â†)">â®</button>
    <span id="mac-viewer-counter">1 / 1</span>
    <button onclick="changeMacImage(1)" title="ä¸‹ä¸€å¼  (â†’)">â¯</button>
    <div class="toolbar-divider"></div>
    <button onclick="closeMacViewer()" title="å…³é—­ (Esc)">âœ•</button>
  </div>
</div>

<style>
/* å¼ºåˆ¶å…¨å±çŠ¶æ€è¦†ç›–æ‰€æœ‰åŠ¨æ€è®¡ç®—çš„æ ·å¼ */
:global(.app-window.is-fullscreen) {
  top: 30px !important;    /* é¿å¼€é¡¶éƒ¨èœå•æ  */
  left: 0 !important;
  width: 100vw !important;
  height: calc(100vh - 30px) !important;
  margin: 0 !important;
  transform: none !important;
  border-radius: 0 !important; /* å…¨å±æ—¶é€šå¸¸å–æ¶ˆåœ†è§’ */
  z-index: 9000 !important;   /* ç¡®ä¿åœ¨æ™®é€šçª—å£ä¹‹ä¸Šï¼Œä½†ä½äºå›¾ç‰‡é¢„è§ˆå±‚ */
}

/* éšè—å…¨å±çŠ¶æ€ä¸‹çš„ç¼©æ”¾æ‰‹æŸ„ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ */
:global(.app-window.is-fullscreen .resizer) {
  display: none;
}
/* 1. åŸºç¡€å¼€å…³ï¼šåªé’ˆå¯¹å¸¦æœ‰ .image-grid-folder çš„å®¹å™¨ */
:global(.image-grid-folder) {
  display: flex !important;
  flex-wrap: wrap !important; /* å…è®¸æ¢è¡Œï¼Œåƒæ–‡ä»¶å¤¹æ’é˜Ÿä¸€æ · */
  gap: 25px !important;       /* å›¾æ ‡ä¹‹é—´çš„é—´è· */
  padding: 15px !important;
  background: rgba(0, 0, 0, 0.03) !important;
  border-radius: 8px !important;
  margin: 20px 0 !important;
  justify-content: flex-start !important; /* å·¦å¯¹é½ */
}

/* 2. å½»åº•æ¸…ç† Markdown è‡ªåŠ¨ç”Ÿæˆçš„ pã€br å¹²æ‰°ï¼Œåªåœ¨ç‰¹å®šå®¹å™¨å†…ç”Ÿæ•ˆ */
:global(.image-grid-folder p), 
:global(.image-grid-folder br) {
  display: contents !important; /* æ¶ˆé™¤åŒ…è£¹å±‚ï¼Œè®©å›¾ç‰‡ç›´æ¥å‚ä¸ flex å¸ƒå±€ */
}

/* 3. ç›®æ ‡å›¾ç‰‡ï¼šæ¨¡æ‹Ÿ Win/Mac æ–‡ä»¶å¤¹ä¸­çš„â€œä¸­å›¾æ ‡â€ */
:global(.image-grid-folder img) {
  /* å¼ºåˆ¶å›ºå®šå°ºå¯¸ (ä¸­å›¾æ ‡) */
  width: 100px !important;
  height: 100px !important;
  min-width: 100px !important;
  
  /* å¸ƒå±€æ ¸å¿ƒï¼šå—çº§æ’å¸ƒä½†åœ¨ flex å®¹å™¨ä¸­æ¨ªå‘æ’åˆ— */
  display: block !important;
  object-fit: cover !important; /* å›¾ç‰‡ä¸æ‹‰ä¼¸ï¼Œè‡ªåŠ¨è£å‰ª */
  
  /* å›¾æ ‡è§†è§‰é£æ ¼ */
  margin: 0 !important;
  background: #fff !important;
  padding: 4px !important;
  border: 1px solid rgba(0, 0, 0, 0.1) !important;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1) !important;
  border-radius: 4px !important;
  
  transition: transform 0.2s ease !important;
}

/* 4. æ‚¬åœæ•ˆæœï¼šæ¨¡æ‹Ÿé€‰ä¸­æ„Ÿ */
:global(.image-grid-folder img:hover) {
  transform: scale(1.1) !important;
  border-color: #007aff !important;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2) !important;
}

/* 5. ä¿æŒå®‰å…¨æ€§ï¼šæ™®é€šåšæ–‡å›¾ç‰‡ä¸å—å½±å“ */
:global(.markdown-body img:not(.image-grid-folder img)) {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 20px auto;
}
/* --- åŸºç¡€å¸ƒå±€ --- */
.view-mac { height: 100vh; width: 100vw; overflow: hidden; position: relative; background: url('https://4kwallpapers.com/images/wallpapers/macos-sierra-glacier-mountains-snow-covered-alpenglow-3840x2160-6420.jpg') center/cover; }
.mac-menubar { height: 30px; background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; color: white; font-size: 13px; z-index: 10000; }
.desktop-icons { padding: 60px 30px; }
.icon-unit { display: flex; flex-direction: column; align-items: center; width: 80px; position: absolute; cursor: pointer; }
.folder-icon { font-size: 50px; }
.icon-label { color: white; font-size: 12px; margin-top: 5px; text-shadow: 0 1px 3px #000; }

/* --- çª—å£æ ·å¼ --- */
.app-window { position: absolute; width: 800px; height: 500px; background: white; border-radius: 12px; box-shadow: 0 30px 100px rgba(0,0,0,0.5); overflow: hidden; transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s; opacity: 0; transform: scale(0.95); display: flex; flex-direction: column; }
.view-mac .app-window.is-fullscreen { width: 100vw !important; height: calc(100vh - 30px) !important; top: 30px !important; left: 0 !important; border-radius: 0 !important; transform: none !important; opacity: 1 !important; z-index: 9999 !important; }
.window-header { height: 40px; background: #f6f6f6; display: flex; align-items: center; padding: 0 15px; position: relative; }
.window-title { position: absolute; width: 100%; text-align: center; color: #666; font-size: 13px; font-weight: 600; pointer-events: none; left: 0; }
.drag-handle { cursor: grab !important; }
.app-window:active .drag-handle { cursor: grabbing !important; }

/* --- Dock æ æ ·å¼ --- */
  .mac-dock-container {
    position: absolute; bottom: 20px; width: 100%;
    display: flex; justify-content: center; pointer-events: none;
    z-index: 9999;
  }

  .mac-dock {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    padding: 8px; border-radius: 20px;
    display: flex; gap: 10px; align-items: center;
    pointer-events: auto; border: 0.5px solid rgba(255, 255, 255, 0.3);
  }
  /* 2. æ ¸å¿ƒï¼šDock å›¾æ ‡é€šç”¨æ ·å¼ï¼ˆåŒ…æ‹¬åŠ¨æ€ç”Ÿæˆçš„ï¼‰ */
  .dock-item, :global(.min-zone .dock-item) {
    width: 50px !important;
    height: 50px !important;
    background: rgba(255, 255, 255, 0.3) !important; /* ç»Ÿä¸€ç£¨ç ‚ç™½ */
    backdrop-filter: blur(10px);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 28px; cursor: pointer;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), margin 0.3s;
    position: relative;
    border: 0.5px solid rgba(255, 255, 255, 0.4);
  }

  /* 3. æ‚¬åœç‰¹æ•ˆ */
  .dock-item:hover, :global(.min-zone .dock-item:hover) {
    transform: scale(1.3) translateY(-10px);
    margin: 0 10px;
  }
  /* 4. åˆ†å‰²çº¿ä¸æœ€å°åŒ–åŒºåŸŸ */
  .dock-divider {
    width: 1px; height: 35px;
    background: rgba(255, 255, 255, 0.3);
    margin: 0 5px; display: none; /* ç”± JS æ§åˆ¶æ˜¾ç¤º */
  }

  .min-zone {
    display: flex; gap: 10px; align-items: center;
  }
  .dock-item { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 28px; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); border-radius: 12px; cursor: pointer; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), margin 0.3s; position: relative; border: 0.5px solid rgba(255, 255, 255, 0.3); }
.dock-item:hover { transform: scale(1.3) translateY(-10px); margin: 0 10px; }
.dock-item.active::after, .min-zone .dock-item::after { content: ''; position: absolute; bottom: -8px; width: 4px; height: 4px; background: rgba(255, 255, 255, 0.8); border-radius: 50%; }
.dock-divider { width: 1px; height: 35px; background: rgba(255, 255, 255, 0.3); margin: 0 10px; display: none; }
.min-zone { display: flex; gap: 10px; }

/* --- è®¿è¾¾ Finder æ ·å¼ --- */
.sidebar { width: 160px; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 12px 8px; border-right: 1px solid rgba(0,0,0,0.1); }
.sidebar-item { padding: 8px 12px; margin: 4px 0; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333; display: flex; align-items: center; gap: 8px; }
.sidebar-item:hover { background: rgba(0, 0, 0, 0.05); }
.sidebar-item.active { background: linear-gradient(180deg, #007AFF 0%, #0056B3 100%); color: white; }
.content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 20px; padding: 20px; }
.grid-item { display: flex; flex-direction: column; align-items: center; padding: 10px; border-radius: 10px; transition: background 0.2s; cursor: pointer; }
.grid-item:hover { background: rgba(0, 0, 0, 0.05); }

/* --- ç›¸å†Œ Photo æ ·å¼ (ä¿®å¤ç‰ˆ) --- */
.photos-container { display: flex; width: 100%; height: 100%; background: #fff; overflow: hidden; }
.photos-sidebar { width: 160px; background: #f6f6f6; border-right: 1px solid #e5e5e5; display: flex; flex-direction: column; flex-shrink: 0; }
.sidebar-group { padding: 15px 15px 5px; font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; }
.photos-main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
.photos-header { padding: 20px 25px; border-bottom: 1px solid #eee; }
.photos-header h2 { margin: 0; font-size: 20px; font-weight: 600; }
.photos-grid { flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); grid-auto-rows: 130px; gap: 10px; padding: 20px; overflow-y: auto; align-content: start; }
.photo-card { width: 100%; height: 100%; border-radius: 4px; overflow: hidden; background: #eee; }
.photo-card img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
.photo-card img:hover { transform: scale(1.05); }

/* --- Safari æ ·å¼ --- */
.safari-full-container { display: flex; flex-direction: column; width: 100%; height: 100%; background: white; }
.safari-nav-bar { height: 44px; background: #f1f1f1; border-bottom: 1px solid #dcdcdc; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.address-capsule { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 2px 30px; font-size: 13px; color: #5f6368; }
.google-viewport { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.google-center-content { width: 100%; max-width: 584px; padding: 0 20px; text-align: center; transform: translateY(-10%); }
.google-branding { font-size: 80px; font-weight: 500; margin-bottom: 30px; font-family: Arial, sans-serif; }
.google-search-input-field { display: flex; align-items: center; height: 46px; border: 1px solid #dfe1e5; border-radius: 24px; padding: 0 15px; transition: box-shadow 0.2s; }
.google-search-input-field:hover, .google-search-input-field:focus-within { box-shadow: 0 1px 6px rgba(32,33,36,0.28); }
.google-search-input-field input { flex: 1; border: none; outline: none; font-size: 16px; padding: 0 10px; background: transparent; }
.google-action-btns button { background: #f8f9fa; border: 1px solid #f8f9fa; border-radius: 4px; color: #3c4043; margin: 20px 4px; padding: 0 16px; height: 36px; cursor: pointer; }

/* --- å…¨å±å›¾ç‰‡æŸ¥çœ‹å™¨æ ·å¼ --- */
.mac-image-viewer { position: fixed; inset: 0; z-index: 99999; display: none; justify-content: center; align-items: center; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(20px); opacity: 0; transition: opacity 0.3s ease; }
.mac-image-viewer.active { display: flex; opacity: 1; }
.mac-viewer-overlay { position: absolute; inset: 0; cursor: zoom-out; }
#mac-viewer-img { max-width: 85%; max-height: 80%; object-fit: contain; border-radius: 10px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); z-index: 10; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s; }
.mac-image-viewer.active #mac-viewer-img { transform: scale(1); }
.mac-viewer-toolbar { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); background: rgba(45, 45, 45, 0.7); backdrop-filter: blur(15px); border: 0.5px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 8px 15px; display: flex; align-items: center; gap: 15px; color: white; z-index: 20; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
.mac-viewer-toolbar button { background: none; border: none; color: white; font-size: 18px; cursor: pointer; padding: 5px 10px; border-radius: 6px; }
.mac-viewer-toolbar button:hover { background: rgba(255,255,255,0.1); }
.toolbar-divider { width: 1px; height: 20px; background: rgba(255,255,255,0.2); }
#mac-viewer-counter { font-size: 13px; font-family: system-ui; min-width: 45px; text-align: center; }

/* æ»šåŠ¨æ¡ç¾åŒ– */
:global(.window-body::-webkit-scrollbar), :global(.content-grid::-webkit-scrollbar), :global(.photos-grid::-webkit-scrollbar) { width: 6px !important; height: 6px !important; }
:global(.window-body::-webkit-scrollbar-thumb), :global(.content-grid::-webkit-scrollbar-thumb), :global(.photos-grid::-webkit-scrollbar-thumb) { background-color: rgba(0, 0, 0, 0.2) !important; border-radius: 10px !important; }

/* Markdown æ ·å¼è¡¥ä¸ */
.markdown-body img { max-width: 100%; height: auto; border-radius: 8px; margin: 20px 0; display: block; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: zoom-in; }
/* ä½¿ç”¨ :global ç¡®ä¿æ ·å¼èƒ½ç©¿é€åˆ° Markdown æ¸²æŸ“å‡ºçš„ HTML ä¸­ */

/* å‚ç›´å±…ä¸­çš„é­”æ³•åŒºåŸŸ */
.google-viewport {
  flex: 1;
  display: flex;
  align-items: center; /* å…³é”®ï¼šå‚ç›´å±…ä¸­ */
  justify-content: center; /* å…³é”®ï¼šæ°´å¹³å±…ä¸­ */
  overflow: hidden;
}

.google-center-content {
  width: 100%;
  max-width: 584px;
  padding: 0 20px;
  text-align: center;
  /* è§†è§‰ä¿®æ­£ï¼šç¨å¾®å‘ä¸Šåç§» 10% çœ‹èµ·æ¥æ›´åƒçœŸçš„ Google */
  transform: translateY(-10%); 
}

.google-branding {
  font-size: 80px;
  font-weight: 500;
  margin-bottom: 30px;
  font-family: Arial, sans-serif;
}

.google-search-input-field {
  display: flex;
  align-items: center;
  height: 46px;
  border: 1px solid #dfe1e5;
  border-radius: 24px;
  padding: 0 15px;
  transition: box-shadow 0.2s;
}

.google-search-input-field:hover,
.google-search-input-field:focus-within {
  box-shadow: 0 1px 6px rgba(32,33,36,0.28);
  border-color: rgba(223,225,229,0);
}

.google-search-input-field input {
  flex: 1;
  border: none;
  outline: none;
  font-size: 16px;
  padding: 0 10px;
  background: transparent;
}

.google-action-btns button {
  background: #f8f9fa;
  border: 1px solid #f8f9fa;
  border-radius: 4px;
  color: #3c4043;
  margin: 20px 4px;
  padding: 0 16px;
  height: 36px;
  font-size: 14px;
  cursor: pointer;
}
</style>

<script is:inline>
// --- 1. å…¨å±€å˜é‡ ---
let windowCount = 0;
let highestZIndex = 1000;
const WIN_W = 800;
const WIN_H = 500;
const STEP = 30;

let macAlbum = [];
let macIndex = 0;

// --- 2. çª—å£ç®¡ç† ---
function bringToFront(el) {
  if (!el) return;
  highestZIndex++;
  el.style.zIndex = highestZIndex;
}

function openWin(id) {
  const el = document.getElementById(id);
  if (!el) {
    console.warn('Window not found:', id);
    return;
  }
  const win = el.querySelector('.app-window');
  
  // Dock æ¿€æ´»çŠ¶æ€
  document.querySelectorAll('.dock-item').forEach(item => {
    if (item.getAttribute('onclick')?.includes(id)) item.classList.add('active');
  });

  // åˆæ¬¡æ‰“å¼€å®šä½
  if (el.style.display === 'none' || el.style.display === '') {
    const screenW = window.innerWidth;
    const screenH = window.innerHeight;
    let left = (screenW - WIN_W) / 2;
    let top = (screenH - WIN_H) / 2 - 40;
    const offset = (windowCount % 10) * STEP;
    win.style.left = (left + offset) + 'px';
    win.style.top = (top + offset) + 'px';
    win.style.margin = "0"; 
    el.style.display = 'block';
    windowCount++;
  }

  setTimeout(() => {
    el.classList.add('active'); 
    win.style.transform = "scale(1)";
    win.style.opacity = "1";
  }, 10);
  
  bringToFront(el);
  const dIcon = document.getElementById('d-icon-' + id);
  if (dIcon) dIcon.remove();
  updateDockDivider();
}

function closeWin(id) {
  const el = document.getElementById(id);
  const win = el.querySelector('.app-window');
  win.style.transform = "scale(0.9)";
  win.style.opacity = "0";
  
  document.querySelectorAll('.dock-item').forEach(item => {
    if (item.getAttribute('onclick')?.includes(id)) item.classList.remove('active');
  });

  setTimeout(() => {
    el.classList.remove('active');
    el.style.display = 'none';
  }, 300);
}

function minWin(id, emoji) {
  const el = document.getElementById(id);
  const win = el.querySelector('.app-window');
  win.style.transform = "scale(0.1) translateY(1000px)";
  win.style.opacity = "0";
  
  setTimeout(() => {
    el.style.display = 'none';
    if (!document.getElementById('d-icon-' + id)) {
      const zone = document.getElementById('min-zone');
      const icon = document.createElement('div');
      icon.id = 'd-icon-' + id;
      icon.className = 'dock-item animated-min'; 
      icon.innerHTML = emoji;
      icon.onclick = () => openWin(id);
      zone.appendChild(icon);
      updateDockDivider();
    }
  }, 300);
}

function toggleFull(btn) {
  const win = btn.closest('.app-window');
  win.classList.toggle('is-fullscreen');
}

function updateDockDivider() {
  const zone = document.getElementById('min-zone');
  const divider = document.getElementById('dock-divider');
  if (divider) divider.style.display = zone.children.length > 0 ? "block" : "none";
}

// --- 3. æ‹–æ‹½é€»è¾‘ ---
let dragObj = null;
let startMouseX, startMouseY, startObjX, startObjY;
document.addEventListener('mousedown', (e) => {
  if (e.target.tagName === 'INPUT') return;
  const handle = e.target.closest('.drag-handle');
  if (!handle) return;
  const target = handle.closest('.app-window') || handle.closest('.icon-unit');
  if (!target || target.classList.contains('is-fullscreen')) return;
  
  dragObj = target;
  dragObj.style.transition = 'none'; 
  const overlay = dragObj.closest('.window-overlay'); // Window wrapper
  if (overlay) bringToFront(overlay); // Use bringToFront on wrapper
  
  startMouseX = e.clientX;
  startMouseY = e.clientY;
  startObjX = dragObj.offsetLeft;
  startObjY = dragObj.offsetTop;
  e.preventDefault(); 
});
document.addEventListener('mousemove', (e) => {
  if (!dragObj) return;
  dragObj.style.left = (startObjX + (e.clientX - startMouseX)) + 'px';
  dragObj.style.top = (startObjY + (e.clientY - startMouseY)) + 'px';
  dragObj.style.margin = "0"; 
});
document.addEventListener('mouseup', () => {
  if (dragObj) {
    if (dragObj.classList.contains('app-window')) {
      dragObj.style.transition = 'transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s';
    }
    dragObj = null;
  }
});

// --- 4. è¾…åŠ©åŠŸèƒ½ ---
// æ—¶é’Ÿ
setInterval(() => {
  const clock = document.getElementById('mac-clock');
  if (clock) {
    const now = new Date();
    clock.innerText = now.toLocaleString('zh-CN', {
      year:'numeric', month:'short', day:'numeric', weekday:'short', 
      hour:'2-digit', minute:'2-digit', hour12:false
    }).replace(/\//g,'å¹´');
  }
}, 1000);

// æœç´¢è”åŠ¨
document.addEventListener('keydown', function(e) {
  if (e.target.id === 'google-search-input' && e.key === 'Enter') {
    const keyword = e.target.value.trim();
    if (!keyword) return;
    const finderSearch = document.getElementById('finder-search');
    if (finderSearch) finderSearch.value = keyword;
    if (window.filterPosts) window.filterPosts();
    window.openWin('mac-finder');
    e.target.value = "";
  }
});

// è®¿è¾¾è¿‡æ»¤
let currentCategory = 'all';
window.filterByCategory = function(cat, el) {
  currentCategory = cat;
  document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
  el.classList.add('active');
  window.filterPosts();
};

window.filterPosts = function() {
  const query = document.getElementById('finder-search')?.value.toLowerCase() || "";
  const items = document.querySelectorAll('.post-item');
  items.forEach(item => {
    const title = item.querySelector('.file-name').innerText.toLowerCase();
    const category = item.querySelector('.file-category').innerText;
    const matchCategory = (currentCategory === 'all' || category === currentCategory);
    const matchSearch = title.includes(query);
    item.style.display = (matchCategory && matchSearch) ? 'flex' : 'none';
  });
};

// --- 5. ç›¸å†Œä¾§è¾¹æ è‡ªåŠ¨ç”Ÿæˆé€»è¾‘ (å·²ä¿®å¤ ID è·å–é—®é¢˜) ---
(function() {
  window.initPhotoNavigation = function() {
    const list = document.getElementById('photos-post-links');
    if (!list) return;

    // æ‰¾åˆ°æ‰€æœ‰æ‘„å½±ç±»åšæ–‡çª—å£å†…éƒ¨
    const postWindows = document.querySelectorAll('.app-window[data-category="æ‘„å½±"]:not(#mac-photos)');
    
    if (postWindows.length === 0) {
      list.innerHTML = '<div class="sidebar-item" style="opacity:0.5">æš‚æ— æ‘„å½±é›†</div>';
      return;
    }

    list.innerHTML = Array.from(postWindows).map(win => {
      const title = win.querySelector('.window-title')?.innerText || "æœªå‘½ååšæ–‡";
      
      // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šID æŒ‚åœ¨ .app-window çš„çˆ¶çº§å…ƒç´ ä¸Šï¼Œä¸åœ¨è¿™é‡Œ
      // å¦‚æœä½ çš„ Window ç»„ä»¶æ˜¯ <div id="slug"><div class="app-window">...</div></div>
      const winId = win.parentElement ? win.parentElement.id : "";
      
      if (!winId) return "";

      // ä½¿ç”¨ openWin è§¦å‘å®Œæ•´çš„å¼€çª—åŠ¨ç”»å’Œ Dock çŠ¶æ€
      return `
        <div class="sidebar-item" onclick="openWin('${winId}')">
          ğŸ“ ${title}
        </div>
      `;
    }).join('');
  };

  const observer = new MutationObserver(() => {
    const win = document.getElementById('mac-photos');
    if (win && win.style.display !== 'none') {
      window.initPhotoNavigation();
    }
  });

  const photoWin = document.getElementById('mac-photos');
  if (photoWin) observer.observe(photoWin, { attributes: true });
})();

// --- 6. å›¾ç‰‡é¢„è§ˆå™¨é€»è¾‘ ---
document.addEventListener('click', function(e) {
  const container = e.target.closest('.markdown-body') || e.target.closest('.post-content');
  if (e.target.tagName === 'IMG' && container) {
    if (e.target.naturalWidth < 50 && e.target.width < 50) return;
    const imgs = Array.from(container.querySelectorAll('img'));
    macAlbum = imgs.map(img => img.src);
    macIndex = macAlbum.indexOf(e.target.src);
    openMacViewer();
  }
});

function openMacViewer() {
  const v = document.getElementById('mac-image-viewer');
  if (!v) return;
  v.style.zIndex = 100000; 
  updateMacUI();
  v.style.display = 'flex';
  setTimeout(() => v.classList.add('active'), 10);
  document.addEventListener('keydown', handleMacKeyDown);
}

function updateMacUI() {
  const img = document.getElementById('mac-viewer-img');
  const counter = document.getElementById('mac-viewer-counter');
  if (img) img.src = macAlbum[macIndex];
  if (counter) counter.innerText = `${macIndex + 1} / ${macAlbum.length}`;
}

window.changeMacImage = function(step) {
  if (macAlbum.length <= 1) return;
  macIndex = (macIndex + step + macAlbum.length) % macAlbum.length;
  const img = document.getElementById('mac-viewer-img');
  img.style.opacity = '0.5';
  updateMacUI();
  setTimeout(() => img.style.opacity = '1', 100);
};

window.closeMacViewer = function() {
  const v = document.getElementById('mac-image-viewer');
  if (v) {
    v.classList.remove('active');
    setTimeout(() => v.style.display = 'none', 300);
  }
  document.removeEventListener('keydown', handleMacKeyDown);
};

function handleMacKeyDown(e) {
  const v = document.getElementById('mac-image-viewer');
  if (v && v.style.display === 'flex') {
    if (e.key === 'ArrowRight') changeMacImage(1);
    if (e.key === 'ArrowLeft') changeMacImage(-1);
    if (e.key === 'Escape') closeMacViewer();
  }
}

// æš´éœ²ç»™å…¨å±€
window.openWin = openWin;
window.closeWin = closeWin;
window.minWin = minWin;
window.toggleFull = toggleFull;
window.bringToFront = bringToFront;
</script>