---
const { posts, categories = [] } = Astro.props;
import Window from './Window.astro';
---

{posts.map((post) => (
  <Window 
    id={`post-${post.id}`} 
    title={post.data.title} 
    emoji={post.data.emoji || 'ğŸ“„'}
    category={post.data.category}  >
    <div class="post-content">
       <post.Content /> 
    </div>
  </Window>
))}

<div class="view-mac">
  <div class="mac-menubar">
    <div class="menu-left"><b>ï£¿</b> <span onclick="openWin('mac-finder')">è®¿è¾¾</span> æ–‡ä»¶ ç¼–è¾‘ æ˜¾ç¤º å‰å¾€ çª—å£ å¸®åŠ©</div>
    <div id="mac-clock"></div>
  </div>

  <div class="desktop-icons">
    <div class="icon-unit drag-handle" onclick="openWin('mac-finder')">
      <div class="folder-icon">ğŸ“‚</div>
      <span class="icon-label">åšæ–‡</span>
    </div>
  </div>

  <Window id="mac-finder" title="è®¿è¾¾" emoji="ğŸ“‚">
    <div slot="header-right" style="position: absolute; right: 15px;">
      <input type="text" id="finder-search" placeholder="æœç´¢æ–‡ç« ..." oninput="filterPosts()" onmousedown="event.stopPropagation()" style="font-size: 12px; padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd; outline: none; cursor: text;" />
    </div>

    <div class="finder-layout" style="display: flex; height: 100%; width: 100%;">
      <div class="sidebar" style="width: 160px; border-right: 1px solid rgba(0,0,0,0.1); padding: 10px; flex-shrink: 0;">
        <div class="sidebar-item active" onclick="filterByCategory('all', this)">ğŸ“„ å…¨éƒ¨æ–‡ç« </div>
        {categories.map(cat => (
          <div class="sidebar-item" onclick={`filterByCategory('${cat}', this)`}>ğŸ“ {cat}</div>
        ))}
      </div>
      
      <div class="content-grid" id="finder-items" style="flex: 1; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; overflow-y: auto; align-content: start;">
        {posts.map(post => (
          <div class="grid-item post-item" onclick={`openWin('post-${post.id}')`}>
            <div class="file-icon" style="font-size: 40px;">ğŸ“„</div>
            <div class="file-name" style="font-size: 12px; margin-top: 5px;">{post.data.title}</div>
            <div class="file-category" style="display:none">{post.data.category}</div>
          </div>
        ))}
      </div>
    </div>
  </Window>

  <Window id="mac-safari" title="" emoji="ğŸ§­">
    <div class="safari-full-container">
      <div class="safari-nav-bar">
        <div class="address-capsule">
          <span class="icon">ğŸ”’</span> google.com
        </div>
      </div>
      <div class="google-viewport">
        <div class="google-center-content">
          <div class="google-branding">
            <span style="color: #4285F4">G</span><span style="color: #EA4335">o</span><span style="color: #FBBC05">o</span><span style="color: #4285F4">g</span><span style="color: #34A853">l</span><span style="color: #EA4335">e</span>
          </div>
          <div class="google-search-group">
            <div class="google-search-input-field">
              <span class="prefix-icon">ğŸ”</span>
              <input type="text" id="google-search-input" placeholder="åœ¨ Google ä¸Šæœç´¢..." autocomplete="off" />
              <span class="suffix-icon">ğŸ™ï¸</span>
            </div>
          </div>
          <div class="google-action-btns">
            <button>Google æœç´¢</button>
            <button>æ‰‹æ°”ä¸é”™</button>
          </div>
        </div>
      </div>
    </div>
  </Window>

  <Window id="mac-photos" title="ç›¸å†Œ" emoji="ğŸ–¼ï¸">
    <div class="photos-container">
      <div class="photos-sidebar">
        <div class="sidebar-group">åº“</div>
        <div class="sidebar-item" id="all-photos-tab">ğŸ“¸ æ‰€æœ‰ç…§ç‰‡</div>
        <div class="sidebar-group">æˆ‘çš„æ‘„å½±é›†</div>
        <div id="photos-post-links" class="sidebar-list">
          </div>
      </div>
      
      <div class="photos-main">
        <div class="photos-header">
          <h2 id="album-title">åŠ è½½ä¸­...</h2>
          <p id="album-stats">æ­£åœ¨è¯»å–æ‘„å½±é›†...</p>
        </div>
        <div id="photos-grid" class="photos-grid">
          </div>
      </div>
    </div>
  </Window>

  <Window id="mac-notes" class="notes-window" title="ä¾¿ç­¾" emoji="ğŸ“">
    <div slot="header-right" style="position: absolute; right: 15px; top: 8px; display: flex; gap: 8px;">
      <button onclick="createNewNote()" title="æ–°å»º" style="cursor:pointer; border:1px solid #ddd; background:#fff; border-radius:4px;">â•</button>
      <button onclick="deleteCurrentNote()" title="åˆ é™¤" style="cursor:pointer; border:1px solid #ddd; background:#fff; border-radius:4px;">ğŸ—‘ï¸</button>
      <button onclick="exportNote()" style="cursor:pointer; font-size:12px; padding:2px 8px; border-radius:4px; border:1px solid #ddd; background:#fff;">ğŸ’¾ å¯¼å‡º</button>
    </div>
  
    <div class="notes-app-container" style="display: flex; height: 100%; background: #fff;">
      <div class="notes-sidebar" style="width: 200px; border-right: 1px solid #eee; background: #fbfbfb; overflow-y: auto;">
        <div id="notes-sidebar-list"></div>
      </div>
      <div class="notes-editor" style="flex: 1; padding: 15px; background: #fff;">
        <textarea id="notes-textarea" 
          placeholder="ç‚¹å‡»å·¦ä¸Šè§’ + æ–°å»ºä¾¿ç­¾..." 
          style="width: 100%; height: 100%; border: none; outline: none; resize: none; font-size: 16px; line-height: 1.6; color: #333;"
        ></textarea>
      </div>
    </div>
  </Window>

  <Window id="mac-message" class="message-window" title="ä¿¡æ¯" emoji="ğŸ’¬">
    <div class="imessage-container">
      <div class="imessage-sidebar">
        <div class="imessage-search">
          <input type="text" placeholder="æœç´¢" disabled />
        </div>
        <div class="imessage-list">
          <div class="imessage-item active">
            <div class="avatar">ğŸ‘¨â€ğŸ’»</div>
            <div class="msg-info">
              <div class="msg-name">ä½œè€…æœ¬äºº</div>
              <div class="msg-preview">æ¬¢è¿æ¥åˆ°æˆ‘çš„æ•°å­—ç©ºé—´ï¼</div>
            </div>
          </div>
          <div class="imessage-item">
            <div class="avatar">ğŸ¤–</div>
            <div class="msg-info">
              <div class="msg-name">æ•°å­—åŠ©æ‰‹</div>
              <div class="msg-preview">æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„ï¼Ÿ</div>
            </div>
          </div>
        </div>
      </div>
  
      <div class="imessage-main">
        <div class="imessage-header">
          <span>æ”¶ä»¶äºº: ä½œè€…æœ¬äºº</span>
        </div>
        <div class="imessage-content" id="chat-flow">
          <div class="bubble-row incoming">
            <div class="bubble">å˜¿ï¼æ¬¢è¿æ¥åˆ°æˆ‘çš„åšå®¢ã€‚</div>
          </div>
          <div class="bubble-row incoming">
            <div class="bubble">ä½ å¯ä»¥ç‚¹å‡»å·¦ä¾§ä¾§è¾¹æ æŸ¥çœ‹æˆ‘çš„æ‘„å½±é›†æˆ–è€…ä¾¿ç­¾ã€‚</div>
          </div>
          <div class="bubble-row outgoing">
            <div class="bubble">å“‡ï¼Œè¿™ä¸ª iMessage ç•Œé¢å¤ªé…·äº†ï¼</div>
          </div>
        </div>
        <div class="imessage-input-area">
          <div class="input-wrapper">
            <input type="text" id="msg-input" placeholder="iMessage" />
            <button onclick="sendMessage()">â¬†ï¸</button>
          </div>
        </div>
      </div>
    </div>
  </Window>

  <Window id="mac-music" class="music-window" title="éŸ³ä¹" emoji="ğŸµ">
    <div class="music-app-container">
      <div class="music-sidebar">
        <div class="sidebar-section">Apple Music</div>
        <div class="sidebar-item active">ğŸ“» æ­£åœ¨æ’­æ”¾</div>
        <div class="sidebar-item">ğŸ  æµè§ˆ</div>
        <div class="sidebar-section">èµ„æ–™åº“</div>
        <div class="sidebar-item">ğŸ•’ æœ€è¿‘æ·»åŠ </div>
        <div class="sidebar-item">ğŸµ æ­Œæ›²</div>
        <div id="music-playlist" class="sidebar-list"></div>
      </div>
  
      <div class="music-main">
        <div class="player-wrapper">
          <iframe 
          id="netease-player"
          width="100%" 
          height="100%" 
          src="//music.163.com/outchain/player?type=0&id=2250100910&auto=0&height=430">
          </iframe>
        </div>
        <div class="player-hint">
          <p>æ­£åœ¨åŒæ­¥ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾åˆ—è¡¨...</p>
        </div>
      </div>
    </div>
  </Window>

  <Window id="mac-trash" class="trash-window" title="åºŸçº¸ç¯“" emoji="ğŸ—‘ï¸">
    <div class="trash-app-container">
      <div class="trash-empty-state">
        <div class="trash-icon-large">ğŸ—‘ï¸</div>
        <h2>åºŸçº¸ç¯“æ˜¯ç©ºçš„</h2>
        <p>ä½ å¯ä»¥å°†ä¸å†éœ€è¦çš„æ–‡ä»¶æ‹–åˆ°è¿™é‡Œã€‚</p>
      </div>
    </div>
  </Window>

  <div class="mac-dock-container">
    <div class="mac-dock">
      <div class="dock-item" onclick="openWin('mac-finder')">ğŸ“‚</div>
      <div class="dock-item" onclick="openWin('mac-safari')">ğŸ§­</div>
      <div class="dock-item" onclick="openWin('mac-photos')">ğŸ–¼ï¸</div>
      <div class="dock-item" onclick="openWin('mac-notes')">ğŸ“</div>
      <div class="dock-item" onclick="openWin('mac-message')">ğŸ’¬</div>
      <div class="dock-item" onclick="openWin('mac-music')">ğŸµ</div>
    
      <div id="dock-divider" class="dock-divider"></div>
      <div id="min-zone" class="min-zone"></div>
      
      <div class="dock-item" onclick="openWin('mac-trash')">ğŸ—‘ï¸</div>
    </div>
  </div>

</div>

<div id="mac-image-viewer" class="mac-image-viewer">
  <div class="mac-viewer-overlay" onclick="closeMacViewer()"></div>
  <img id="mac-viewer-img" src="" alt="é¢„è§ˆå›¾ç‰‡" />
  <div class="mac-viewer-toolbar">
    <button onclick="changeMacImage(-1)" title="ä¸Šä¸€å¼  (â†)">â®</button>
    <span id="mac-viewer-counter">1 / 1</span>
    <button onclick="changeMacImage(1)" title="ä¸‹ä¸€å¼  (â†’)">â¯</button>
    <div class="toolbar-divider"></div>
    <button onclick="closeMacViewer()" title="å…³é—­ (Esc)">âœ•</button>
  </div>
</div>

<style>
/* å¼ºåˆ¶å…¨å±çŠ¶æ€è¦†ç›–æ‰€æœ‰åŠ¨æ€è®¡ç®—çš„æ ·å¼ */
:global(.app-window.is-fullscreen) {
  top: 30px !important;    /* é¿å¼€é¡¶éƒ¨èœå•æ  */
  left: 0 !important;
  width: 100vw !important;
  height: calc(100vh - 30px) !important;
  margin: 0 !important;
  transform: none !important;
  border-radius: 0 !important; /* å…¨å±æ—¶é€šå¸¸å–æ¶ˆåœ†è§’ */
  z-index: 9000 !important;   /* ç¡®ä¿åœ¨æ™®é€šçª—å£ä¹‹ä¸Šï¼Œä½†ä½äºå›¾ç‰‡é¢„è§ˆå±‚ */
}

/* éšè—å…¨å±çŠ¶æ€ä¸‹çš„ç¼©æ”¾æ‰‹æŸ„ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ */
:global(.app-window.is-fullscreen .resizer) {
  display: none;
}
/* 1. åŸºç¡€å¼€å…³ï¼šåªé’ˆå¯¹å¸¦æœ‰ .image-grid-folder çš„å®¹å™¨ */
:global(.image-grid-folder) {
  display: flex !important;
  flex-wrap: wrap !important; /* å…è®¸æ¢è¡Œï¼Œåƒæ–‡ä»¶å¤¹æ’é˜Ÿä¸€æ · */
  gap: 25px !important;       /* å›¾æ ‡ä¹‹é—´çš„é—´è· */
  padding: 15px !important;
  background: rgba(0, 0, 0, 0.03) !important;
  border-radius: 8px !important;
  margin: 20px 0 !important;
  justify-content: flex-start !important; /* å·¦å¯¹é½ */
}

/* 2. å½»åº•æ¸…ç† Markdown è‡ªåŠ¨ç”Ÿæˆçš„ pã€br å¹²æ‰°ï¼Œåªåœ¨ç‰¹å®šå®¹å™¨å†…ç”Ÿæ•ˆ */
:global(.image-grid-folder p), 
:global(.image-grid-folder br) {
  display: contents !important; /* æ¶ˆé™¤åŒ…è£¹å±‚ï¼Œè®©å›¾ç‰‡ç›´æ¥å‚ä¸ flex å¸ƒå±€ */
}

/* 3. ç›®æ ‡å›¾ç‰‡ï¼šæ¨¡æ‹Ÿ Win/Mac æ–‡ä»¶å¤¹ä¸­çš„â€œä¸­å›¾æ ‡â€ */
:global(.image-grid-folder img) {
  /* å¼ºåˆ¶å›ºå®šå°ºå¯¸ (ä¸­å›¾æ ‡) */
  width: 100px !important;
  height: 100px !important;
  min-width: 100px !important;
  
  /* å¸ƒå±€æ ¸å¿ƒï¼šå—çº§æ’å¸ƒä½†åœ¨ flex å®¹å™¨ä¸­æ¨ªå‘æ’åˆ— */
  display: block !important;
  object-fit: cover !important; /* å›¾ç‰‡ä¸æ‹‰ä¼¸ï¼Œè‡ªåŠ¨è£å‰ª */
  
  /* å›¾æ ‡è§†è§‰é£æ ¼ */
  margin: 0 !important;
  background: #fff !important;
  padding: 4px !important;
  border: 1px solid rgba(0, 0, 0, 0.1) !important;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1) !important;
  border-radius: 4px !important;
  
  transition: transform 0.2s ease !important;
}

/* 4. æ‚¬åœæ•ˆæœï¼šæ¨¡æ‹Ÿé€‰ä¸­æ„Ÿ */
:global(.image-grid-folder img:hover) {
  transform: scale(1.1) !important;
  border-color: #007aff !important;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2) !important;
}

/* 5. ä¿æŒå®‰å…¨æ€§ï¼šæ™®é€šåšæ–‡å›¾ç‰‡ä¸å—å½±å“ */
:global(.markdown-body img:not(.image-grid-folder img)) {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 20px auto;
}
/* --- åŸºç¡€å¸ƒå±€ --- */
.view-mac { height: 100vh; width: 100vw; overflow: hidden; position: relative; background: url('https://4kwallpapers.com/images/wallpapers/macos-sierra-glacier-mountains-snow-covered-alpenglow-3840x2160-6420.jpg') center/cover; }
.mac-menubar { height: 30px; background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; color: white; font-size: 13px; z-index: 10000; }
.desktop-icons { padding: 60px 30px; }
.icon-unit { display: flex; flex-direction: column; align-items: center; width: 80px; position: absolute; cursor: pointer; }
.folder-icon { font-size: 50px; }
.icon-label { color: white; font-size: 12px; margin-top: 5px; text-shadow: 0 1px 3px #000; }

/* --- çª—å£æ ·å¼ --- */
.app-window { position: absolute; width: 800px; height: 500px; background: white; border-radius: 12px; box-shadow: 0 30px 100px rgba(0,0,0,0.5); overflow: hidden; transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s; opacity: 0; transform: scale(0.95); display: flex; flex-direction: column; }
.view-mac .app-window.is-fullscreen { width: 100vw !important; height: calc(100vh - 30px) !important; top: 30px !important; left: 0 !important; border-radius: 0 !important; transform: none !important; opacity: 1 !important; z-index: 9999 !important; }
.window-header { height: 40px; background: #f6f6f6; display: flex; align-items: center; padding: 0 15px; position: relative; }
.window-title { position: absolute; width: 100%; text-align: center; color: #666; font-size: 13px; font-weight: 600; pointer-events: none; left: 0; }
.drag-handle { cursor: grab !important; }
.app-window:active .drag-handle { cursor: grabbing !important; }

/* --- Dock æ æ ·å¼ --- */
  .mac-dock-container {
    position: absolute; bottom: 20px; width: 100%;
    display: flex; justify-content: center; pointer-events: none;
    z-index: 9999;
  }

  .mac-dock {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    padding: 8px; border-radius: 20px;
    display: flex; gap: 10px; align-items: center;
    pointer-events: auto; border: 0.5px solid rgba(255, 255, 255, 0.3);
  }
  /* 2. æ ¸å¿ƒï¼šDock å›¾æ ‡é€šç”¨æ ·å¼ï¼ˆåŒ…æ‹¬åŠ¨æ€ç”Ÿæˆçš„ï¼‰ */
  .dock-item, :global(.min-zone .dock-item) {
    width: 50px !important;
    height: 50px !important;
    background: rgba(255, 255, 255, 0.3) !important; /* ç»Ÿä¸€ç£¨ç ‚ç™½ */
    backdrop-filter: blur(10px);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 28px; cursor: pointer;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), margin 0.3s;
    position: relative;
    border: 0.5px solid rgba(255, 255, 255, 0.4);
  }

  /* 3. æ‚¬åœç‰¹æ•ˆ */
  .dock-item:hover, :global(.min-zone .dock-item:hover) {
    transform: scale(1.3) translateY(-10px);
    margin: 0 10px;
  }
  /* 4. åˆ†å‰²çº¿ä¸æœ€å°åŒ–åŒºåŸŸ */
  .dock-divider {
    width: 1px; height: 35px;
    background: rgba(255, 255, 255, 0.3);
    margin: 0 5px; display: none; /* ç”± JS æ§åˆ¶æ˜¾ç¤º */
  }

  .min-zone {
    display: flex; gap: 10px; align-items: center;
  }
  .dock-item { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 28px; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); border-radius: 12px; cursor: pointer; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), margin 0.3s; position: relative; border: 0.5px solid rgba(255, 255, 255, 0.3); }
.dock-item:hover { transform: scale(1.3) translateY(-10px); margin: 0 10px; }
.dock-item.active::after, .min-zone .dock-item::after { content: ''; position: absolute; bottom: -8px; width: 4px; height: 4px; background: rgba(255, 255, 255, 0.8); border-radius: 50%; }
.dock-divider { width: 1px; height: 35px; background: rgba(255, 255, 255, 0.3); margin: 0 10px; display: none; }
.min-zone { display: flex; gap: 10px; }

/* --- è®¿è¾¾ Finder æ ·å¼ --- */
.sidebar { width: 160px; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 12px 8px; border-right: 1px solid rgba(0,0,0,0.1); }
.sidebar-item { padding: 8px 12px; margin: 4px 0; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333; display: flex; align-items: center; gap: 8px; }
.sidebar-item:hover { background: rgba(0, 0, 0, 0.05); }
.sidebar-item.active { background: linear-gradient(180deg, #007AFF 0%, #0056B3 100%); color: white; }
.content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 20px; padding: 20px; }
.grid-item { display: flex; flex-direction: column; align-items: center; padding: 10px; border-radius: 10px; transition: background 0.2s; cursor: pointer; }
.grid-item:hover { background: rgba(0, 0, 0, 0.05); }

/* --- ç›¸å†Œ Photo æ ·å¼ (ä¿®å¤ç‰ˆ) --- */
.photos-container { display: flex; width: 100%; height: 100%; background: #fff; overflow: hidden; }
.photos-sidebar { width: 160px; background: #f6f6f6; border-right: 1px solid #e5e5e5; display: flex; flex-direction: column; flex-shrink: 0; }
.sidebar-group { padding: 15px 15px 5px; font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; }
.photos-main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
.photos-header { padding: 20px 25px; border-bottom: 1px solid #eee; }
.photos-header h2 { margin: 0; font-size: 20px; font-weight: 600; }
.photos-grid { flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); grid-auto-rows: 130px; gap: 10px; padding: 20px; overflow-y: auto; align-content: start; }
.photo-card { width: 100%; height: 100%; border-radius: 4px; overflow: hidden; background: #eee; }
.photo-card img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
.photo-card img:hover { transform: scale(1.05); }

/* --- Safari æ ·å¼ --- */
.safari-full-container { display: flex; flex-direction: column; width: 100%; height: 100%; background: white; }
.safari-nav-bar { height: 44px; background: #f1f1f1; border-bottom: 1px solid #dcdcdc; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.address-capsule { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 2px 30px; font-size: 13px; color: #5f6368; }
.google-viewport { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.google-center-content { width: 100%; max-width: 584px; padding: 0 20px; text-align: center; transform: translateY(-10%); }
.google-branding { font-size: 80px; font-weight: 500; margin-bottom: 30px; font-family: Arial, sans-serif; }
.google-search-input-field { display: flex; align-items: center; height: 46px; border: 1px solid #dfe1e5; border-radius: 24px; padding: 0 15px; transition: box-shadow 0.2s; }
.google-search-input-field:hover, .google-search-input-field:focus-within { box-shadow: 0 1px 6px rgba(32,33,36,0.28); }
.google-search-input-field input { flex: 1; border: none; outline: none; font-size: 16px; padding: 0 10px; background: transparent; }
.google-action-btns button { background: #f8f9fa; border: 1px solid #f8f9fa; border-radius: 4px; color: #3c4043; margin: 20px 4px; padding: 0 16px; height: 36px; cursor: pointer; }

/* --- å…¨å±å›¾ç‰‡æŸ¥çœ‹å™¨æ ·å¼ --- */
.mac-image-viewer { position: fixed; inset: 0; z-index: 99999; display: none; justify-content: center; align-items: center; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(20px); opacity: 0; transition: opacity 0.3s ease; }
.mac-image-viewer.active { display: flex; opacity: 1; }
.mac-viewer-overlay { position: absolute; inset: 0; cursor: zoom-out; }
#mac-viewer-img { max-width: 85%; max-height: 80%; object-fit: contain; border-radius: 10px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); z-index: 10; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s; }
.mac-image-viewer.active #mac-viewer-img { transform: scale(1); }
.mac-viewer-toolbar { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); background: rgba(45, 45, 45, 0.7); backdrop-filter: blur(15px); border: 0.5px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 8px 15px; display: flex; align-items: center; gap: 15px; color: white; z-index: 20; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
.mac-viewer-toolbar button { background: none; border: none; color: white; font-size: 18px; cursor: pointer; padding: 5px 10px; border-radius: 6px; }
.mac-viewer-toolbar button:hover { background: rgba(255,255,255,0.1); }
.toolbar-divider { width: 1px; height: 20px; background: rgba(255,255,255,0.2); }
#mac-viewer-counter { font-size: 13px; font-family: system-ui; min-width: 45px; text-align: center; }

/* æ»šåŠ¨æ¡ç¾åŒ– */
:global(.window-body::-webkit-scrollbar), :global(.content-grid::-webkit-scrollbar), :global(.photos-grid::-webkit-scrollbar) { width: 6px !important; height: 6px !important; }
:global(.window-body::-webkit-scrollbar-thumb), :global(.content-grid::-webkit-scrollbar-thumb), :global(.photos-grid::-webkit-scrollbar-thumb) { background-color: rgba(0, 0, 0, 0.2) !important; border-radius: 10px !important; }

/* Markdown æ ·å¼è¡¥ä¸ */
.markdown-body img { max-width: 100%; height: auto; border-radius: 8px; margin: 20px 0; display: block; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: zoom-in; }
/* ä½¿ç”¨ :global ç¡®ä¿æ ·å¼èƒ½ç©¿é€åˆ° Markdown æ¸²æŸ“å‡ºçš„ HTML ä¸­ */

/* å‚ç›´å±…ä¸­çš„é­”æ³•åŒºåŸŸ */
.google-viewport {
  flex: 1;
  display: flex;
  align-items: center; /* å…³é”®ï¼šå‚ç›´å±…ä¸­ */
  justify-content: center; /* å…³é”®ï¼šæ°´å¹³å±…ä¸­ */
  overflow: hidden;
}

.google-center-content {
  width: 100%;
  max-width: 584px;
  padding: 0 20px;
  text-align: center;
  /* è§†è§‰ä¿®æ­£ï¼šç¨å¾®å‘ä¸Šåç§» 10% çœ‹èµ·æ¥æ›´åƒçœŸçš„ Google */
  transform: translateY(-10%); 
}

.google-branding {
  font-size: 80px;
  font-weight: 500;
  margin-bottom: 30px;
  font-family: Arial, sans-serif;
}

.google-search-input-field {
  display: flex;
  align-items: center;
  height: 46px;
  border: 1px solid #dfe1e5;
  border-radius: 24px;
  padding: 0 15px;
  transition: box-shadow 0.2s;
}

.google-search-input-field:hover,
.google-search-input-field:focus-within {
  box-shadow: 0 1px 6px rgba(32,33,36,0.28);
  border-color: rgba(223,225,229,0);
}

.google-search-input-field input {
  flex: 1;
  border: none;
  outline: none;
  font-size: 16px;
  padding: 0 10px;
  background: transparent;
}

.google-action-btns button {
  background: #f8f9fa;
  border: 1px solid #f8f9fa;
  border-radius: 4px;
  color: #3c4043;
  margin: 20px 4px;
  padding: 0 16px;
  height: 36px;
  font-size: 14px;
  cursor: pointer;
}
/* ============================================================
   ç›¸å†Œçª—å£ä¸“é¡¹æ ·å¼ - å¼ºåŒ–ç‰ˆï¼ˆå¸¦ :global ç¡®ä¿ç”Ÿæ•ˆï¼‰
   ============================================================ */

/* 1. å®¹å™¨ä¸å¸ƒå±€ */
:global(.photos-container) {
  display: flex !important;
  width: 100% !important;
  height: 100% !important;
  background: #ffffff !important;
  overflow: hidden !important;
}

/* 2. ä¾§è¾¹æ æ ·å¼ */
:global(.photos-sidebar) {
  width: 180px !important;
  background: #f6f6f6 !important;
  border-right: 1px solid rgba(0, 0, 0, 0.1) !important;
  display: flex !important;
  flex-direction: column !important;
  padding: 10px 0 !important;
  flex-shrink: 0 !important;
}

:global(.photos-sidebar .sidebar-group) {
  padding: 10px 15px 5px !important;
  font-size: 11px !important;
  font-weight: 700 !important;
  color: #8e8e93 !important;
  text-transform: uppercase !important;
}

:global(.photos-sidebar .sidebar-item) {
  padding: 8px 15px !important;
  margin: 2px 8px !important;
  border-radius: 6px !important;
  font-size: 13px !important;
  color: #333 !important;
  cursor: pointer !important;
  transition: all 0.2s !important;
}

:global(.photos-sidebar .sidebar-item:hover) {
  background: rgba(0, 0, 0, 0.05) !important;
}

/* å…³é”®ï¼šä¾§è¾¹æ é€‰ä¸­é«˜äº® */
:global(.photos-sidebar .sidebar-item.active) {
  background: #007aff !important;
  color: #ffffff !important;
}

/* 3. å³ä¾§ä¸»å†…å®¹åŒº */
:global(.photos-main) {
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
  min-width: 0 !important;
}

:global(.photos-header) {
  padding: 20px 25px !important;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05) !important;
}

/* 4. å›¾ç‰‡ç½‘æ ¼ - æ ¸å¿ƒä¿®å¤ */
:global(.photos-grid) {
  flex: 1 !important;
  display: grid !important;
  /* å¼ºåˆ¶æ¨ªå‘å¹³é“ºï¼Œæ¯è¡Œè‡³å°‘èƒ½æ”¾å‡ ä¸ª */
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)) !important;
  grid-auto-rows: 130px !important;
  gap: 12px !important;
  padding: 20px !important;
  overflow-y: auto !important;
  align-content: start !important;
}

/* 5. ç…§ç‰‡å¡ç‰‡ */
:global(.photo-card) {
  width: 100% !important;
  height: 100% !important;
  border-radius: 4px !important;
  overflow: hidden !important;
  background: #eee !important;
}

:global(.photo-card img) {
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
  display: block !important;
  transition: transform 0.3s !important;
}

:global(.photo-card img:hover) {
  transform: scale(1.05) !important;
}
/* --- ä¾¿ç­¾çª—å£åº•å±‚ç»“æ„ä¿®å¤ --- */
:global(.notes-window .window-body) {
  display: block !important;
  padding: 0 !important;
  overflow: hidden !important;
}

/* --- ä¾¿ç­¾ä¸»å®¹å™¨ (æ¯›ç»ç’ƒ & å¸ƒå±€) --- */
:global(.notes-app-container) {
  display: flex !important;
  width: 100% !important;
  height: 100% !important;
  background: rgba(255, 255, 255, 0.7) !important;
  backdrop-filter: blur(20px) !important;
}

/* --- å·¦ä¾§è¾¹æ  --- */
:global(.notes-sidebar) {
  width: 200px !important;
  flex-shrink: 0 !important;
  background: rgba(246, 246, 246, 0.5) !important;
  border-right: 1px solid rgba(0, 0, 0, 0.08) !important;
  padding: 10px 8px !important;
  overflow-y: auto !important;
}

/* --- åˆ—è¡¨é¡¹ (å¡ç‰‡è´¨æ„Ÿ) --- */
:global(.note-list-item) {
  padding: 10px 12px !important;
  margin-bottom: 4px !important;
  border-radius: 8px !important;
  cursor: pointer !important;
  transition: all 0.2s ease !important;
}

:global(.note-list-item:hover) {
  background: rgba(0, 0, 0, 0.04) !important;
}

/* æ¿€æ´»æ€ï¼šmacOS ç»å…¸è“ */
:global(.note-list-item.active) {
  background: #007aff !important;
  box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2) !important;
}

:global(.note-list-item.active .note-item-title) { color: white !important; }
:global(.note-list-item.active .note-item-date) { color: rgba(255, 255, 255, 0.7) !important; }

/* åˆ—è¡¨æ–‡å­—æ ·å¼ */
:global(.note-item-title) {
  font-size: 13px !important;
  font-weight: 600 !important;
  color: #1d1d1f !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
}

:global(.note-item-date) {
  font-size: 11px !important;
  color: #86868b !important;
  margin-top: 2px !important;
}

/* --- å³ä¾§ç¼–è¾‘åŒº --- */
:global(.notes-editor) {
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
  background: white !important;
  min-width: 0 !important;
}

:global(#notes-textarea) {
  flex: 1 !important;
  width: 100% !important;
  height: 100% !important;
  padding: 25px 30px !important;
  border: none !important;
  outline: none !important;
  resize: none !important;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
  font-size: 15px !important;
  line-height: 1.6 !important;
  color: #1d1d1f !important;
  box-sizing: border-box !important;
}
/* --- ä¿¡æ¯çª—å£åº•å±‚ç»“æ„ä¿®å¤ (å¼ºåŠ›ç©¿é€) --- */
:global(.message-window .window-body) {
  display: block !important; /* è§£é™¤ flex é™åˆ¶ */
  padding: 0 !important;
  overflow: hidden !important; /* ç¡®ä¿å†…å®¹ä¸æº¢å‡º */
}

/* --- iMessage å¸ƒå±€ --- */
:global(.imessage-container) {
  display: flex !important;
  height: 100% !important;
  background: white !important; /* é»˜è®¤çº¯ç™½èƒŒæ™¯ */
  backdrop-filter: blur(20px) !important; /* å‡è£…æœ‰æ¯›ç»ç’ƒæ•ˆæœï¼Œä½†åº•å±‚çª—å£æ˜¯ç™½è‰² */
}

/* --- ä¾§è¾¹æ  --- */
:global(.imessage-sidebar) {
  width: 240px !important;
  flex-shrink: 0 !important;
  border-right: 1px solid rgba(0, 0, 0, 0.08) !important;
  display: flex !important;
  flex-direction: column !important;
  background: #f6f6f6 !important; /* æ¯”ä¸»çª—å£æ›´æš—ä¸€ç‚¹ */
}

:global(.imessage-search) { padding: 10px !important; }
:global(.imessage-search input) {
  width: 100% !important;
  background: #e3e3e3 !important;
  border: none !important;
  border-radius: 6px !important;
  padding: 6px 10px !important; /* ç¨å¾®å¤§ä¸€ç‚¹çš„å†…è¾¹è· */
  font-size: 13px !important;
  color: #333 !important;
  outline: none !important;
}

:global(.imessage-list) { flex: 1 !important; overflow-y: auto !important; }

:global(.imessage-item) {
  display: flex !important;
  padding: 10px 15px !important;
  gap: 12px !important;
  cursor: pointer !important;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05) !important; /* æ›´æŸ”å’Œçš„åˆ†å‰²çº¿ */
  transition: background 0.2s ease !important;
}

:global(.imessage-item:hover) { background: rgba(0, 0, 0, 0.03) !important; }

:global(.imessage-item.active) {
  background: #007aff !important;
  color: white !important;
}
:global(.imessage-item.active .msg-preview) { color: rgba(255, 255, 255, 0.8) !important; }

:global(.imessage-item .avatar) {
  font-size: 28px !important;
  width: 32px; /* å›ºå®šå®½åº¦ï¼Œé˜²æ­¢å¤´åƒå¤§å°ä¸ä¸€ */
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: #e0e0e0; /* é»˜è®¤å¤´åƒèƒŒæ™¯ */
  flex-shrink: 0;
}

:global(.imessage-item .msg-info) { flex: 1 !important; overflow: hidden !important; }
:global(.imessage-name) { font-weight: 600 !important; font-size: 14px !important; color: #1d1d1f !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; }
:global(.imessage-item.active .msg-name) { color: white !important; }
:global(.imessage-preview) { font-size: 12px !important; color: #8e8e93 !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; }

/* --- èŠå¤©ä¸»åŒºåŸŸ --- */
:global(.imessage-main) {
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
  min-width: 0 !important; /* å…³é”®ï¼Œé˜²æ­¢å†…å®¹æº¢å‡º */
  background: white !important; /* ç¡®ä¿æ˜¯ç™½è‰²èƒŒæ™¯ */
}
:global(.imessage-header) {
  padding: 10px 15px !important;
  text-align: center !important;
  font-size: 12px !important;
  color: #8e8e93 !important;
  border-bottom: 1px solid rgba(0, 0, 0, 0.08) !important;
  flex-shrink: 0 !important;
}

:global(.imessage-content) {
  flex: 1 !important;
  padding: 20px 25px !important; /* å¢åŠ å·¦å³ç•™ç™½ */
  overflow-y: auto !important;
  display: flex !important;
  flex-direction: column !important;
  gap: 8px !important;
  background: #fdfdfd !important; /* ç•¥å¸¦ä¸€ç‚¹ç‚¹ç°ï¼Œå¢åŠ å±‚æ¬¡æ„Ÿ */
}

/* æ°”æ³¡æ ·å¼ */
:global(.bubble-row) {
  display: flex !important;
  width: 100% !important;
}
:global(.bubble-row.incoming) { justify-content: flex-start !important; }
:global(.bubble-row.outgoing) { justify-content: flex-end !important; }

:global(.bubble) {
  max-width: 70% !important;
  padding: 9px 16px !important; /* ç¨å¾®è°ƒæ•´æ°”æ³¡å¤§å° */
  border-radius: 20px !important; /* æ›´åœ†æ¶¦çš„è¾¹è§’ */
  font-size: 14px !important;
  line-height: 1.4 !important;
  word-wrap: break-word !important; /* é•¿æ–‡æœ¬è‡ªåŠ¨æ¢è¡Œ */
}

:global(.incoming .bubble) {
  background: #e9e9eb !important;
  color: black !important;
  border-bottom-left-radius: 4px !important; /* å°å°¾å·´æ¨¡æ‹Ÿ */
}

:global(.outgoing .bubble) {
  background: linear-gradient(180deg, #05d1ff 0%, #007aff 100%) !important;
  color: white !important;
  border-bottom-right-radius: 4px !important;
}

/* è¾“å…¥æ¡†åŒºåŸŸ */
:global(.imessage-input-area) {
  padding: 15px 20px !important; /* å¢åŠ å·¦å³ç•™ç™½ */
  flex-shrink: 0 !important;
  background: white !important;
  border-top: 1px solid rgba(0, 0, 0, 0.08) !important;
}
:global(.input-wrapper) {
  display: flex !important;
  align-items: center !important;
  border: 1px solid #e5e5e5 !important;
  border-radius: 20px !important;
  padding: 4px 5px 4px 15px !important; /* å·¦ä¾§ç•™ç™½å¤šä¸€ç‚¹ */
}

:global(.input-wrapper input) {
  flex: 1 !important;
  border: none !important;
  outline: none !important;
  padding: 5px 0 !important; /* è°ƒæ•´å†…è¾¹è· */
  font-size: 14px !important;
}

:global(.input-wrapper button) {
  background: #007aff !important;
  color: white !important;
  border: none !important;
  width: 28px !important; /* ç¨å¾®å¤§ä¸€ç‚¹çš„æŒ‰é’® */
  height: 28px !important;
  border-radius: 50% !important;
  cursor: pointer !important;
  font-size: 14px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  margin-left: 8px !important;
}
/* --- ç©¿é€ä¿®å¤ï¼šåŒæ—¶è§£å†³ä¾¿ç­¾å’Œä¿¡æ¯çš„å¸ƒå±€é—®é¢˜ --- */
:global(.notes-window .window-body),
:global(.message-window .window-body) {
  display: block !important; /* æ ¸å¿ƒï¼šå–æ¶ˆ flexï¼Œè®©å†…éƒ¨ imessage-container è‡ªç”±å‘æŒ¥ */
  padding: 0 !important;
  overflow: hidden !important;
}

/* --- ä¿¡æ¯çª—å£å†…éƒ¨å®¹å™¨ä¿®å¤ --- */
:global(.imessage-container) {
  display: flex !important; /* è¿™é‡Œå†å¼€å¯ flex ç”¨äºå·¦å³å¸ƒå±€ */
  width: 100% !important;
  height: 100% !important;
  background: white !important;
}

/* --- ç¡®ä¿èŠå¤©ä¸»åŒºåŸŸæ’‘æ»¡å‰©ä½™ç©ºé—´ --- */
:global(.imessage-main) {
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
  min-width: 0 !important; /* é˜²æ­¢å†…å®¹è¿‡é•¿æ’‘ç ´å¸ƒå±€ */
}

/* --- è¾“å…¥æ¡†å®¹å™¨å®½åº¦ä¿®å¤ --- */
:global(.imessage-input-area) {
  width: 100% !important;
  box-sizing: border-box !important;
}
/* 1. é¡¶å±‚ç»“æ„ç©¿é€ (ç¡®ä¿ä¸‰ä¸ªçª—å£éƒ½æ¨ªå‘é“ºæ»¡) */
:global(.notes-window .window-body),
:global(.message-window .window-body),
:global(.music-window .window-body) {
  display: block !important;
  padding: 0 !important;
  overflow: hidden !important; /* å½»åº•å¹²æ‰å¤–å±‚å†—ä½™æ»šåŠ¨æ¡ */
}

/* 2. éŸ³ä¹çª—å£å†…éƒ¨ä¸»å®¹å™¨ */
:global(.music-app-container) {
  display: flex !important;
  width: 100% !important;
  height: 100% !important;
  background: #fff !important;
}

/* 3. å·¦ä¾§è¾¹æ ç¾åŒ– (ç²¾ç®€æ¯”ä¾‹) */
:global(.music-sidebar) {
  width: 180px !important;
  flex-shrink: 0 !important;
  background: #f6f6f6 !important;
  border-right: 1px solid rgba(0, 0, 0, 0.08) !important;
  padding: 20px 10px !important;
  display: flex !important;
  flex-direction: column !important;
}

:global(.sidebar-item) {
  padding: 8px 12px !important;
  border-radius: 6px !important;
  font-size: 13px !important;
  cursor: pointer !important;
  color: #1d1d1f !important;
}

:global(.sidebar-item.active) {
  background: #fa2d48 !important; /* Apple Music çº¢ */
  color: white !important;
}

/* 4. å³ä¾§æ’­æ”¾å™¨æ ¸å¿ƒåŒº (å¹²æ‰å¤šä½™æ–‡å­—å’Œç©ºéš™) */
:global(.music-main) {
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
  background: white !important;
  overflow: hidden !important; /* å…³é”®ï¼šé˜²æ­¢äº§ç”ŸåŒæ»šåŠ¨æ¡ */
}

/* 5. æ’­æ”¾å™¨å®¹å™¨ï¼šå½»åº•é“ºæ»¡ */
:global(.player-wrapper) {
  flex: 1 !important;
  width: 100% !important;
  height: 100% !important;
  display: block !important;
}

/* 6. å¼ºåˆ¶ iframe æ’‘å¼€å¹¶å»æ‰è¾¹æ¡† */
:global(#netease-player) {
  width: 100% !important;
  height: 100% !important;
  border: none !important;
  display: block !important;
}

/* 7. éšè—ä¸éœ€è¦çš„å ä½å…ƒç´  */
:global(.player-hint) {
  display: none !important;
}
/* 1. ç©¿é€ä¿®å¤ï¼šåŠ å…¥åƒåœ¾æ¡¶çª—å£ */
:global(.notes-window .window-body),
:global(.message-window .window-body),
:global(.music-window .window-body),
:global(.trash-window .window-body) {
  display: block !important;
  padding: 0 !important;
  overflow: hidden !important;
}

/* 2. åƒåœ¾æ¡¶ä¸»å®¹å™¨ */
:global(.trash-app-container) {
  width: 100% !important;
  height: 100% !important;
  background: white !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
}

/* 3. ç©ºçŠ¶æ€ç¾åŒ– */
:global(.trash-empty-state) {
  text-align: center !important;
  color: #8e8e93 !important; /* macOS å…¸å‹çš„ç°è‰²æ–‡å­— */
}

:global(.trash-icon-large) {
  font-size: 64px !important;
  margin-bottom: 15px !important;
  opacity: 0.2 !important; /* åŠé€æ˜æ•ˆæœï¼Œæ˜¾å¾—æ›´ç²¾è‡´ */
}

:global(.trash-empty-state h2) {
  font-size: 18px !important;
  font-weight: 600 !important;
  color: #1d1d1f !important;
  margin-bottom: 8px !important;
}

:global(.trash-empty-state p) {
  font-size: 13px !important;
}
</style>

<script is:inline>
  // --- 1. å…¨å±€å˜é‡ ---
  let windowCount = 0;
  let highestZIndex = 1000;
  const WIN_W = 800;
  const WIN_H = 500;
  const STEP = 30;
  
  let macAlbum = [];
  let macIndex = 0;
  
  // --- 2. çª—å£ç®¡ç† ---
  function bringToFront(el) {
    if (!el) return;
    highestZIndex++;
    el.style.zIndex = highestZIndex;
  }
  
  function openWin(id) {
    const el = document.getElementById(id);
    if (!el) {
      console.warn('Window not found:', id);
      return;
    }
    const win = el.querySelector('.app-window');
    
    document.querySelectorAll('.dock-item').forEach(item => {
      if (item.getAttribute('onclick')?.includes(id)) item.classList.add('active');
    });
  
    if (el.style.display === 'none' || el.style.display === '') {
      const screenW = window.innerWidth;
      const screenH = window.innerHeight;
      let left = (screenW - WIN_W) / 2;
      let top = (screenH - WIN_H) / 2 - 40;
      const offset = (windowCount % 10) * STEP;
      win.style.left = (left + offset) + 'px';
      win.style.top = (top + offset) + 'px';
      win.style.margin = "0"; 
      el.style.display = 'block';
      windowCount++;
    }
  
    setTimeout(() => {
      el.classList.add('active'); 
      win.style.transform = "scale(1)";
      win.style.opacity = "1";
    }, 10);
    
    bringToFront(el);
    const dIcon = document.getElementById('d-icon-' + id);
    if (dIcon) dIcon.remove();
    updateDockDivider();
  }
  
  function closeWin(id) {
    const el = document.getElementById(id);
    const win = el.querySelector('.app-window');
    win.style.transform = "scale(0.9)";
    win.style.opacity = "0";
    
    document.querySelectorAll('.dock-item').forEach(item => {
      if (item.getAttribute('onclick')?.includes(id)) item.classList.remove('active');
    });
  
    setTimeout(() => {
      el.classList.remove('active');
      el.style.display = 'none';
    }, 300);
  }
  
  function minWin(id, emoji) {
    const el = document.getElementById(id);
    const win = el.querySelector('.app-window');
    win.style.transform = "scale(0.1) translateY(1000px)";
    win.style.opacity = "0";
    
    setTimeout(() => {
      el.style.display = 'none';
      if (!document.getElementById('d-icon-' + id)) {
        const zone = document.getElementById('min-zone');
        const icon = document.createElement('div');
        icon.id = 'd-icon-' + id;
        icon.className = 'dock-item animated-min'; 
        icon.innerHTML = emoji;
        icon.onclick = () => openWin(id);
        zone.appendChild(icon);
        updateDockDivider();
      }
    }, 300);
  }
  
  function toggleFull(btn) {
    const win = btn.closest('.app-window');
    win.classList.toggle('is-fullscreen');
  }
  
  function updateDockDivider() {
    const zone = document.getElementById('min-zone');
    const divider = document.getElementById('dock-divider');
    if (divider) divider.style.display = zone.children.length > 0 ? "block" : "none";
  }
  
  // --- 3. æ‹–æ‹½é€»è¾‘ ---
  let dragObj = null;
  let startMouseX, startMouseY, startObjX, startObjY;
  document.addEventListener('mousedown', (e) => {
    if (e.target.tagName === 'INPUT') return;
    const handle = e.target.closest('.drag-handle');
    if (!handle) return;
    const target = handle.closest('.app-window') || handle.closest('.icon-unit');
    if (!target || target.classList.contains('is-fullscreen')) return;
    
    dragObj = target;
    dragObj.style.transition = 'none'; 
    const overlay = dragObj.closest('.window-overlay');
    if (overlay) bringToFront(overlay);
    
    startMouseX = e.clientX;
    startMouseY = e.clientY;
    startObjX = dragObj.offsetLeft;
    startObjY = dragObj.offsetTop;
    e.preventDefault(); 
  });
  document.addEventListener('mousemove', (e) => {
    if (!dragObj) return;
    dragObj.style.left = (startObjX + (e.clientX - startMouseX)) + 'px';
    dragObj.style.top = (startObjY + (e.clientY - startMouseY)) + 'px';
    dragObj.style.margin = "0"; 
  });
  document.addEventListener('mouseup', () => {
    if (dragObj) {
      if (dragObj.classList.contains('app-window')) {
        dragObj.style.transition = 'transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s';
      }
      dragObj = null;
    }
  });
  
  // --- 4. è¾…åŠ©åŠŸèƒ½ ---
  setInterval(() => {
    const clock = document.getElementById('mac-clock');
    if (clock) {
      const now = new Date();
      clock.innerText = now.toLocaleString('zh-CN', {
        year:'numeric', month:'short', day:'numeric', weekday:'short', 
        hour:'2-digit', minute:'2-digit', hour12:false
      }).replace(/\//g,'å¹´');
    }
  }, 1000);
  
  document.addEventListener('keydown', function(e) {
    if (e.target.id === 'google-search-input' && e.key === 'Enter') {
      const keyword = e.target.value.trim();
      if (!keyword) return;
      const finderSearch = document.getElementById('finder-search');
      if (finderSearch) finderSearch.value = keyword;
      if (window.filterPosts) window.filterPosts();
      window.openWin('mac-finder');
      e.target.value = "";
    }
  });
  
  let currentCategory = 'all';
  window.filterByCategory = function(cat, el) {
    currentCategory = cat;
    document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
    el.classList.add('active');
    window.filterPosts();
  };
  
  window.filterPosts = function() {
    const query = document.getElementById('finder-search')?.value.toLowerCase() || "";
    const items = document.querySelectorAll('.post-item');
    items.forEach(item => {
      const title = item.querySelector('.file-name').innerText.toLowerCase();
      const category = item.querySelector('.file-category').innerText;
      const matchCategory = (currentCategory === 'all' || category === currentCategory);
      const matchSearch = title.includes(query);
      item.style.display = (matchCategory && matchSearch) ? 'flex' : 'none';
    });
  };
  
  // --- 6. å›¾ç‰‡é¢„è§ˆå™¨é€»è¾‘ ---
  document.addEventListener('click', function(e) {
    const container = e.target.closest('.markdown-body') || e.target.closest('.post-content');
    if (e.target.tagName === 'IMG' && container) {
      if (e.target.naturalWidth < 50 && e.target.width < 50) return;
      const imgs = Array.from(container.querySelectorAll('img'));
      macAlbum = imgs.map(img => img.src);
      macIndex = macAlbum.indexOf(e.target.src);
      openMacViewer();
    }
  });
  
  function openMacViewer() {
    const v = document.getElementById('mac-image-viewer');
    if (!v) return;
    v.style.zIndex = 100000; 
    updateMacUI();
    v.style.display = 'flex';
    setTimeout(() => v.classList.add('active'), 10);
    document.addEventListener('keydown', handleMacKeyDown);
  }
  
  function updateMacUI() {
    const img = document.getElementById('mac-viewer-img');
    const counter = document.getElementById('mac-viewer-counter');
    if (img) img.src = macAlbum[macIndex];
    if (counter) counter.innerText = `${macIndex + 1} / ${macAlbum.length}`;
  }
  
  window.changeMacImage = function(step) {
    if (macAlbum.length <= 1) return;
    macIndex = (macIndex + step + macAlbum.length) % macAlbum.length;
    const img = document.getElementById('mac-viewer-img');
    img.style.opacity = '0.5';
    updateMacUI();
    setTimeout(() => img.style.opacity = '1', 100);
  };
  
  window.closeMacViewer = function() {
    const v = document.getElementById('mac-image-viewer');
    if (v) {
      v.classList.remove('active');
      setTimeout(() => v.style.display = 'none', 300);
    }
    document.removeEventListener('keydown', handleMacKeyDown);
  };
  
  function handleMacKeyDown(e) {
    const v = document.getElementById('mac-image-viewer');
    if (v && v.style.display === 'flex') {
      if (e.key === 'ArrowRight') changeMacImage(1);
      if (e.key === 'ArrowLeft') changeMacImage(-1);
      if (e.key === 'Escape') closeMacViewer();
    }
  }
  
  // æš´éœ²ç»™å…¨å±€
  window.openWin = openWin;
  window.closeWin = closeWin;
  window.minWin = minWin;
  window.toggleFull = toggleFull;
  window.bringToFront = bringToFront;
  
  </script>