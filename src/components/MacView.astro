---
const { posts, categories = [] } = Astro.props;
import Window from './Window.astro';
---

<div class="view-mac">
  <div class="mac-menubar">
    <div class="menu-left"><b>ï£¿</b> <span onclick="openWin('mac-finder')">è®¿è¾¾</span> æ–‡ä»¶ ç¼–è¾‘ æ˜¾ç¤º å‰å¾€ çª—å£ å¸®åŠ©</div>
    <div id="mac-clock"></div>
  </div>

  <div class="desktop-icons">
    <div class="icon-unit drag-handle" onclick="openWin('mac-finder')">
      <div class="folder-icon">ğŸ“‚</div>
      <span class="icon-label">åšæ–‡</span>
    </div>
  </div>

  <Window id="mac-finder" title="è®¿è¾¾" emoji="ğŸ“‚">
    <div slot="header-right" style="position: absolute; right: 15px;">
      <input type="text" id="finder-search" placeholder="æœç´¢æ–‡ç« ..." oninput="filterPosts()" onmousedown="event.stopPropagation()" style="font-size: 12px; padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd; outline: none; cursor: text;" />
    </div>

    <div class="finder-layout" style="display: flex; height: 100%; width: 100%;">
      <div class="sidebar" style="width: 160px; border-right: 1px solid rgba(0,0,0,0.1); padding: 10px; flex-shrink: 0;">
        <div class="sidebar-item active" onclick="filterByCategory('all', this)">ğŸ“„ å…¨éƒ¨æ–‡ç« </div>
        {categories.map(cat => (
          <div class="sidebar-item" onclick={`filterByCategory('${cat}', this)`}>ğŸ“ {cat}</div>
        ))}
      </div>
      
      <div class="content-grid" id="finder-items" style="flex: 1; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; overflow-y: auto; align-content: start;">
        {posts.map(post => (
          <div class="grid-item post-item" onclick={`openWin('post-${post.id}')`}>
            <div class="file-icon" style="font-size: 40px;">ğŸ“„</div>
            <div class="file-name" style="font-size: 12px; margin-top: 5px;">{post.data.title}</div>
            <div class="file-category" style="display:none">{post.data.category}</div>
          </div>
        ))}
      </div>
    </div>
  </Window>

  <Window id="mac-safari" title="æµè§ˆå™¨" emoji="ğŸ§­">
    <div style="padding: 40px; text-align: center; width: 100%;">
      <h2>æ¨¡æ‹Ÿæµè§ˆå™¨çª—å£</h2>
      <p>è¿™é‡Œå¯ä»¥æ”¾ä½ çš„ä¸ªäººä»‹ç»æˆ–è€…å…¶ä»–é¡¹ç›®ã€‚</p>
    </div>
  </Window>

  <Window id="mac-message" title="æ ‡ç­¾" emoji="ğŸ§­">
    <div style="padding: 40px; text-align: center; width: 100%;">
      <h2>æ¨¡æ‹Ÿæµè§ˆå™¨çª—å£</h2>
      <img src="https://4kwallpapers.com/images/walls/thumbs_3t/6420.jpg"/>
    </div>
  </Window>

  {posts.map(post => (
  <Window id={`post-${post.id}`} title="æ–‡ç« é¢„è§ˆ" emoji="ğŸ“„">
    <div class="post-content" style="padding: 30px; width: 100%; height: 100%; overflow-y: auto; background: #fff; color: #333;">
      <div style="max-width: 800px; margin: 0 auto;">
        <h1 style="margin-top: 0; font-size: 28px; color: #000;">{post.data.title}</h1>
        
        <div class="post-meta" style="color: #888; font-size: 14px; margin-bottom: 15px; display: flex; gap: 15px;">
           <span>ğŸ“… {post.data.date}</span>
           {post.data.category && <span>ğŸ“ {post.data.category}</span>}
        </div>
        
        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;" />
        
        <div class="markdown-body" style="line-height: 1.8; font-size: 16px;">
          <post.Content />
        </div>
      </div>
    </div>
  </Window>
))}

  <div class="mac-dock-container">
    <div class="mac-dock">
      <div class="dock-item" onclick="openWin('mac-finder')">ğŸ“‚</div>
      <div class="dock-item" onclick="openWin('mac-safari')">ğŸ§­</div>
      <div class="dock-item" onclick="openWin('mac-message')">ğŸ’¬</div>
      <div id="dock-divider" class="dock-divider"></div>
      <div id="min-zone" class="min-zone"></div>
    </div>
  </div>
</div>

<div id="mac-image-viewer" class="mac-image-viewer">
  <div class="mac-viewer-overlay" onclick="closeMacViewer()"></div>
  
  <img id="mac-viewer-img" src="" alt="é¢„è§ˆå›¾ç‰‡" />

  <div class="mac-viewer-toolbar">
    <button onclick="changeMacImage(-1)" title="ä¸Šä¸€å¼  (â†)">â®</button>
    <span id="mac-viewer-counter">1 / 1</span>
    <button onclick="changeMacImage(1)" title="ä¸‹ä¸€å¼  (â†’)">â¯</button>
    <div class="toolbar-divider"></div>
    <button onclick="closeMacViewer()" title="å…³é—­ (Esc)">âœ•</button>
  </div>
</div>

<style>
/* ä½¿ç”¨ :global ç¡®ä¿æ ·å¼èƒ½ç©¿é€åˆ° Markdown æ¸²æŸ“å‡ºçš„ HTML ä¸­ */
  
  :global(.image-grid-folder) {
    display: grid;
    /* è‡ªåŠ¨å¡«å……ï¼Œæ¨¡æ‹Ÿè®¿è¾¾çš„ç½‘æ ¼å¸ƒå±€ */
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 25px;
    padding: 20px;
    background: rgba(0, 0, 0, 0.02);
    border-radius: 12px;
    margin: 20px 0;
    justify-items: center;
  }

  :global(.image-grid-folder img) {
    /* å¼ºåˆ¶å›ºå®šå¤§å°ï¼Œæ¨¡æ‹Ÿä¸­å›¾æ ‡ */
    width: 110px !important;
    height: 110px !important;
    object-fit: cover !important;
    margin: 0 !important;
    
    /* è®¿è¾¾å›¾æ ‡é£æ ¼ï¼šç™½è‰²åº•è¾¹ã€ç»†è¾¹æ¡†ã€æŠ•å½± */
    background: #ffffff;
    padding: 3px;
    border: 0.5px solid rgba(0, 0, 0, 0.15);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    border-radius: 4px;
    
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  :global(.image-grid-folder img:hover) {
    transform: scale(1.08) translateY(-2px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
    border-color: #007aff; /* æ¨¡æ‹Ÿé€‰ä¸­çš„è“è‰² */
  }

  /* é€‚é…æ­£æ–‡é‡Œçš„å…¶ä»–æ™®é€šå›¾ç‰‡ï¼Œä¹Ÿç¨å¾®æ§åˆ¶ä¸€ä¸‹ */
  :global(.markdown-body img:not(.image-grid-folder img)) {
    max-width: 60%;
    height: auto;
    display: block;
    margin: 20px auto;
    border-radius: 8px;
    cursor: zoom-in;
  }
/* é’ˆå¯¹ Mac çª—å£å†… Markdown å†…å®¹çš„å…¨å±€æ ·å¼è¡¥ä¸ */
  .markdown-body img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 20px 0;
    display: block;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .markdown-body p {
    margin-bottom: 1.5em;
  }
  .markdown-body h2 {
    margin-top: 1.5em;
    border-bottom: 1px solid #eee;
    padding-bottom: 0.3em;
  }
  .markdown-body pre {
    background: #f6f8fa;
    padding: 16px;
    border-radius: 6px;
    overflow: auto;
    font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, monospace;
  }
/* ä½¿ç”¨ :global ç¡®ä¿æ ·å¼èƒ½ç©¿é€ç»„ä»¶éš”ç¦» */
  :global(.window-body::-webkit-scrollbar),
  :global(.sidebar::-webkit-scrollbar),
  :global(.content-grid::-webkit-scrollbar) {
    width: 6px !important;  /* è°ƒç»†ä¸€ç‚¹æ›´åƒ Mac */
    height: 6px !important;
  }

  :global(.window-body::-webkit-scrollbar-track) {
    background: transparent !important;
  }

  :global(.window-body::-webkit-scrollbar-thumb) {
    background-color: rgba(0, 0, 0, 0.2) !important; /* åŠé€æ˜ç°è‰² */
    border-radius: 10px !important;
    border: 1px solid transparent !important;
    background-clip: content-box !important;
  }

  :global(.window-body::-webkit-scrollbar-thumb:hover) {
    background-color: rgba(0, 0, 0, 0.4) !important; /* é¼ æ ‡æ‚¬æµ®æ—¶åŠ æ·± */
  }
img {
  max-width: 100%; /* å›¾ç‰‡æ°¸è¿œä¸ä¼šè¶…è¿‡çª—å£å®½åº¦ */
  height: auto;
}
/* è®©å›¾æ ‡åˆ’è¿‡æ—¶å˜å¤§ */
.dock-item {
  font-size: 28px; /* è°ƒå¤§ Emoji å¤§å° */
  cursor: pointer !important;
  transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); /* å¸¦æœ‰å¼¹æ€§çš„æ”¾å¤§ */
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.dock-item:hover {
  transform: scale(1.3) translateY(-10px); /* å‘ä¸Šæµ®åŠ¨å¹¶æ”¾å¤§ */
}

/* æ­£åœ¨è¿è¡Œçš„å°åœ†ç‚¹æŒ‡ç¤ºç¯ */
.dock-item.active::after {
  content: '';
  position: absolute;
  bottom: -8px;
  width: 4px;
  height: 4px;
  background: rgba(0, 0, 0, 0.6); /* é»‘è‰²å°åœ†ç‚¹ */
  border-radius: 50%;
}
/* æ‰¾ä¸€ä¸‹ä½ çš„æ¡Œé¢æœ€å¤–å±‚ div çš„ç±»åï¼Œæ¯”å¦‚ .os-container æˆ– .desktop */
.os-container {
  -webkit-user-select: none; /* Safari */
  -ms-user-select: none;      /* IE */
  user-select: none;          /* æ ‡å‡† */
}

/* å”¯ç‹¬å…è®¸åšæ–‡çª—å£é‡Œçš„æ­£æ–‡å¯ä»¥è¢«é€‰ä¸­ï¼ˆæ–¹ä¾¿ä»¥åå¤åˆ¶æ–‡å­—ï¼‰ */
.post-window-content {
  user-select: text !important;
  -webkit-user-select: text !important;
}
/* ç»™æ‰€æœ‰å¯ç‚¹å‡»çš„é¡¹ç›®ç»Ÿä¸€åŠ å°æ‰‹ */

/* 1. é¡¶æ çš„èœå•é¡¹ */
.menu-item, .clock {
  cursor: pointer;
}

/* 2. Dock æ çš„å›¾æ ‡ */
.dock-item {
  cursor: pointer;
}
/* 1. ç¡®ä¿æ–‡ç« å›¾æ ‡æ•´ä½“å’Œå†…éƒ¨æ‰€æœ‰ä¸œè¥¿ï¼ˆå›¾æ ‡ã€æ–‡å­—ï¼‰éƒ½æ˜¯å°æ‰‹ */
.post-item, 
.post-item * { 
  cursor: pointer !important; 
}

/* 2. ç¡®ä¿ä¾§è¾¹æ åˆ†ç±»ä¹Ÿæ˜¯å°æ‰‹ */
.sidebar-item, 
.sidebar-item * {
  cursor: pointer !important;
}

/* 3. é¡¶æ èœå• */
.menu-item {
  cursor: pointer !important;
}

/* 4. æ’é™¤æœç´¢è¾“å…¥æ¡†ï¼ˆè¾“å…¥æ¡†å¿…é¡»ç»´æŒç«–æ ï¼Œå¦åˆ™å¾ˆéš¾çœ‹ï¼‰ */
#finder-search {
  cursor: text !important;
}
.top-bar {
  user-select: none !important;
  -webkit-user-select: none !important;
  -ms-user-select: none !important;
  -moz-user-select: none !important;
  cursor: default !important; /* é¡¶æ èƒŒæ™¯ç»´æŒæ ‡å‡†ç®­å¤´ */
}
/* å‡¡æ˜¯æœ‰å…³é—­ã€æ‰“å¼€ã€åˆ‡æ¢åŠŸèƒ½çš„æŒ‰é’®ï¼Œç»Ÿç»Ÿæ˜¾ç¤ºå°æ‰‹ */
[onclick], 
button, 
.drag-handle {
  cursor: pointer;
}

/* ä½†æ˜¯ï¼Œæ‹–æ‹½åŒºåŸŸå¦‚æœæ­£åœ¨æ‹–æ‹½ï¼Œå»ºè®®ç»´æŒåŸæ ·æˆ–ç”¨ grabbing */
.app-window.dragging {
  cursor: grabbing;
}
/* ç¦æ­¢é€‰ä¸­é¡¶æ æ–‡å­— */
.top-bar {
  user-select: none;         /* ç°ä»£æµè§ˆå™¨ */
  -webkit-user-select: none;  /* Safari/Chrome */
  cursor: default;           /* ç¡®ä¿é¼ æ ‡åœ¨é¡¶æ æ˜¯é»˜è®¤ç®­å¤´ */
}
body {
  cursor: default; /* å…¨å±€é»˜è®¤æ˜¯ç®­å¤´ */
  margin: 0;
  overflow: hidden;
}
/* å¦‚æœä½ ä¹Ÿæƒ³è®©æ•´ä¸ªæ¡Œé¢èƒŒæ™¯éƒ½ä¸èƒ½é€‰æ–‡å­—ï¼Œå¯ä»¥åŠ ç»™æ¡Œé¢çš„å®¹å™¨ */
.desktop-container {
  user-select: none;
  -webkit-user-select: none;
}
/* è®©åˆ†ç±»æ–‡å­—å°ä¸€ç‚¹ï¼Œç°ä¸€ç‚¹ï¼Œæ›´æœ‰ç§‘æŠ€æ„Ÿ */
  .file-category {
    font-size: 10px;
    color: #999;
    background: rgba(0,0,0,0.05);
    border-radius: 4px;
    padding: 1px 4px;
    display: inline-block;
    margin-top: 2px;
  }
  .view-mac {
    height: 100vh; width: 100vw; overflow: hidden;
    background: url('https://4kwallpapers.com/images/wallpapers/macos-sierra-glacier-mountains-snow-covered-alpenglow-3840x2160-6420.jpg') center/cover;
    position: relative;
  }
  .mac-menubar {
    height: 30px; background: rgba(255,255,255,0.1); backdrop-filter: blur(20px);
    display: flex; justify-content: space-between; align-items: center;
    padding: 0 15px; color: white; font-size: 13px; z-index: 10000;
  }
  .window-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    display: none; z-index: 1000; pointer-events: none;
  }
  .window-overlay.active { display: block; } 

  .app-window {
    position: absolute;
    width: 800px;
    height: 500px;
    background: white; border-radius: 12px; overflow: hidden;
    display: flex; flex-direction: column; pointer-events: auto;
    box-shadow: 0 30px 100px rgba(0,0,0,0.5);
    /* æ‰“å¼€æ—¶çš„åŠ¨ç”»ï¼Œæ‹–æ‹½æ—¶ä¼šé€šè¿‡ JS ç§»é™¤ transition */
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s;
    transform: scale(0.95); opacity: 0;
  }
  
  /* å¼ºåˆ¶å…¨å±æ ·å¼ï¼Œå¢åŠ ä¼˜å…ˆçº§ */
  .view-mac .app-window.is-fullscreen {
    width: 100vw !important;
    height: calc(100vh - 30px) !important;
    top: 30px !important;
    left: 0 !important;
    border-radius: 0 !important;
    transform: none !important;
    opacity: 1 !important;
    z-index: 9999 !important;
  }

  .window-header { height: 40px; background: #f6f6f6; display: flex; align-items: center; padding: 0 15px; position: relative; }
  /* é¼ æ ‡æŒ‡åœ¨æ ‡é¢˜æ ä¸Šæ—¶æ˜¾ç¤ºâ€œå‡†å¤‡æŠ“å–çš„æ‰‹â€ */
.drag-handle {
  cursor: grab !important;
}

/* æ­£åœ¨æ‹–æ‹½æ—¶æ˜¾ç¤ºâ€œæŠ“ç´§çš„æ‰‹â€ */
.app-window:active, .icon-unit:active {
  cursor: grabbing !important;
}
  .dot-group { display: flex; gap: 8px; z-index: 5; }
  .dot { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; }
  .dot-red { background: #ff5f56; } .dot-yellow { background: #ffbd2e; } .dot-green { background: #27c93f; }
  .window-title { position: absolute; width: 100%; text-align: center; color: #666; font-size: 13px; font-weight: 600; pointer-events: none; left: 0; }

  /* Dock æ ·å¼ */
  .mac-dock-container { position: absolute; bottom: 10px; width: 100%; display: flex; justify-content: center; pointer-events: none; }
  .mac-dock { background: rgba(255,255,255,0.2); backdrop-filter: blur(20px); padding: 8px; border-radius: 20px; display: flex; gap: 10px; align-items: center; pointer-events: auto; }
  .dock-item { width: 50px; height: 50px; background: white; border-radius: 12px; font-size: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
  .dock-divider { width: 1px; height: 35px; background: rgba(255,255,255,0.3); display: none; margin: 0 5px; }
  .min-zone { display: flex; gap: 10px; }
  
  /* åˆ—è¡¨æ ·å¼ */
  .desktop-icons { padding: 60px 30px; }
  .icon-unit { display: flex; flex-direction: column; align-items: center; width: 80px; position: absolute; }
  .folder-icon { font-size: 50px; }
  .icon-label { color: white; font-size: 12px; margin-top: 5px; text-shadow: 0 1px 3px #000; }
  .finder-layout { user-select: none; display: flex; flex: 1; height: 100%; }
  .sidebar { width: 160px; background: #f0f0f0; padding: 15px; }
  .content-grid { flex: 1; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, 80px); gap: 20px; }
  .grid-item { text-align: center; cursor: pointer; }
  .file-icon { font-size: 40px; }
  .file-name { font-size: 11px; margin-top: 5px; }
  .post-content { user-select: text !important; padding: 40px; overflow-y: auto; background: white; }
  /* ä¾§è¾¹æ å®¹å™¨ï¼šå¢åŠ å†…è¾¹è· */
.sidebar {
  padding: 12px 8px; /* ä¾§è¾¹æ•´ä½“ç•™ç™½ */
  background: rgba(255, 255, 255, 0.4); /* åŠé€æ˜ç£¨ç ‚æ„Ÿ */
  backdrop-filter: blur(10px);
}

/* ä¾§è¾¹æ æ ‡ç­¾ï¼ˆåˆ†ç±»åï¼‰æ ·å¼ */
.sidebar-item {
  padding: 8px 12px;
  margin: 4px 0; /* å¢åŠ ä¸Šä¸‹é—´è·ï¼Œä¸å†æ‹¥æŒ¤ */
  border-radius: 8px; /* è‹¹æœé£æ ¼çš„åœ†è§’ */
  cursor: pointer;
  font-size: 13px;
  color: #333;
  transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1); /* ä¸æ»‘è¿‡æ¸¡ */
  display: flex;
  align-items: center;
  gap: 8px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
}

/* é¼ æ ‡æ‚¬æµ®æ•ˆæœ */
.sidebar-item:hover {
  background: rgba(0, 0, 0, 0.05);
}

/* ç‚¹å‡»/æ¿€æ´»çŠ¶æ€ï¼šè‹¹æœç»å…¸è“è‰² */
.sidebar-item.active {
  background: linear-gradient(180deg, #007AFF 0%, #0056B3 100%);
  color: white;
  box-shadow: 0 2px 4px rgba(0, 122, 255, 0.3);
}

/* åˆ†ç±»æ ‡ç­¾çš„æ–‡å­—ç¨å¾®å˜ç»†ä¸€ç‚¹ï¼Œæ›´æœ‰é«˜çº§æ„Ÿ */
.sidebar-label {
  font-size: 11px;
  font-weight: 600;
  color: #8e8e93;
  padding: 10px 12px 4px;
  text-transform: uppercase; /* è‹±æ–‡åˆ†ç±»ä¼šå˜å¤§å†™ï¼Œæ›´æœ‰è®¾è®¡æ„Ÿ */
}
.content-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 20px; /* å¢åŠ æ–‡ä»¶å›¾æ ‡ä¹‹é—´çš„é—´è· */
  padding: 20px;
}

.grid-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px;
  border-radius: 10px;
  transition: background 0.2s;
}

.grid-item:hover {
  background: rgba(0, 0, 0, 0.05); /* é¼ æ ‡ç§»ä¸Šå»æœ‰ä¸ªæµ…è‰²åº• */
}
.mac-image-viewer {
    position: fixed; inset: 0; z-index: 99999;
    display: none; justify-content: center; align-items: center;
    background: rgba(0, 0, 0, 0.3); /* è¾ƒæµ…çš„é®ç½©ï¼Œé æ¨¡ç³Šå‡ºæ•ˆæœ */
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    opacity: 0; transition: opacity 0.3s ease;
  }
  .mac-image-viewer.active { display: flex; opacity: 1; }

  .mac-viewer-overlay { position: absolute; inset: 0; cursor: zoom-out; }

  #mac-viewer-img {
    max-width: 85%; max-height: 80%;
    object-fit: contain; border-radius: 10px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    z-index: 10; transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s;
  }
  .mac-image-viewer.active #mac-viewer-img { transform: scale(1); }

  /* æ‚¬æµ®å·¥å…·æ  */
  .mac-viewer-toolbar {
    position: absolute; bottom: 40px; left: 50%;
    transform: translateX(-50%);
    background: rgba(45, 45, 45, 0.7);
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    border: 0.5px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px; padding: 8px 15px;
    display: flex; align-items: center; gap: 15px;
    color: white; z-index: 20;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }

  .mac-viewer-toolbar button {
    background: none; border: none; color: white;
    font-size: 18px; cursor: pointer; padding: 5px 10px;
    border-radius: 6px; transition: background 0.2s;
  }
  .mac-viewer-toolbar button:hover { background: rgba(255,255,255,0.1); }
  
  .toolbar-divider { width: 1px; height: 20px; background: rgba(255,255,255,0.2); }
  
  #mac-viewer-counter { font-size: 13px; font-family: system-ui; min-width: 45px; text-align: center; }
</style>

<script is:inline>
// --- 1. å…¨å±€å˜é‡å®šä¹‰ ---
let windowCount = 0;
let highestZIndex = 1000;
const WIN_W = 800;
const WIN_H = 500;
const STEP = 30;

// Mac å›¾ç‰‡é¢„è§ˆçŠ¶æ€
let macAlbum = [];
let macIndex = 0;

// --- 2. ç½®é¡¶é€»è¾‘ ---
function bringToFront(el) {
  if (!el) return;
  highestZIndex++;
  el.style.zIndex = highestZIndex;
}

// --- 3. çª—å£æ§åˆ¶ ---
function openWin(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const win = el.querySelector('.app-window');

  document.querySelectorAll('.dock-item').forEach(item => {
    if (item.getAttribute('onclick')?.includes(id)) {
      item.classList.add('active');
    }
  });

  if (el.style.display === 'none' || el.style.display === '') {
    const screenW = window.innerWidth;
    const screenH = window.innerHeight;
    let left = (screenW - WIN_W) / 2;
    let top = (screenH - WIN_H) / 2 - 40;
    const offset = (windowCount % 10) * STEP;
    win.style.left = (left + offset) + 'px';
    win.style.top = (top + offset) + 'px';
    win.style.margin = "0"; 
    el.style.display = 'block';
    windowCount++; 
  }

  setTimeout(() => {
    el.classList.add('active'); 
    win.style.transform = "scale(1)";
    win.style.opacity = "1";
  }, 10);

  bringToFront(el);
  const dIcon = document.getElementById('d-icon-' + id);
  if (dIcon) dIcon.remove();
  updateDockDivider();
}

function closeWin(id) {
  const el = document.getElementById(id);
  const win = el.querySelector('.app-window');
  win.style.transform = "scale(0.9)";
  win.style.opacity = "0";
  document.querySelectorAll('.dock-item').forEach(item => {
    if (item.getAttribute('onclick')?.includes(id)) {
      item.classList.remove('active');
    }
  });
  setTimeout(() => {
    el.classList.remove('active');
    el.style.display = 'none';
  }, 300);
}

function minWin(id, emoji) {
  const el = document.getElementById(id);
  const win = el.querySelector('.app-window');
  win.style.transform = "scale(0.1) translateY(1000px)";
  win.style.opacity = "0";
  setTimeout(() => {
    el.style.display = 'none';
    if (!document.getElementById('d-icon-' + id)) {
      const zone = document.getElementById('min-zone');
      const icon = document.createElement('div');
      icon.id = 'd-icon-' + id;
      icon.className = 'dock-item';
      icon.innerHTML = emoji;
      icon.onclick = () => openWin(id);
      zone.appendChild(icon);
      updateDockDivider();
    }
  }, 300);
}

function toggleFull(btn) {
  const win = btn.closest('.app-window');
  win.classList.toggle('is-fullscreen');
}

function updateDockDivider() {
  const zone = document.getElementById('min-zone');
  const divider = document.getElementById('dock-divider');
  if (divider) divider.style.display = zone.children.length > 0 ? "block" : "none";
}

// --- 4. ç”µè„‘ç«¯å›¾ç‰‡é¢„è§ˆ (æ ¸å¿ƒåŒ¹é…ï¼šmarkdown-body) ---
document.addEventListener('click', function(e) {
  // å…³é”®ï¼šåŒ¹é…ä½  HTML é‡Œçš„ .markdown-body æˆ–å…¶ä»–å¯èƒ½çš„å®¹å™¨
  const container = e.target.closest('.markdown-body') || e.target.closest('.post-content');
  
  if (e.target.tagName === 'IMG' && container) {
    // è¿‡æ»¤æ‰å¤ªå°çš„å›¾æ ‡
    if (e.target.naturalWidth < 50 && e.target.width < 50) return;

    const imgs = Array.from(container.querySelectorAll('img'));
    macAlbum = imgs.map(img => img.src);
    macIndex = macAlbum.indexOf(e.target.src);
    
    openMacViewer();
  }
});

function openMacViewer() {
  const v = document.getElementById('mac-image-viewer');
  if (!v) return;
  
  // ç¡®ä¿é¢„è§ˆå™¨å§‹ç»ˆåœ¨è®¿è¾¾çª—å£ä¹‹ä¸Š
  v.style.zIndex = 100000; 
  
  updateMacUI();
  v.style.display = 'flex';
  setTimeout(() => v.classList.add('active'), 10);
  document.addEventListener('keydown', handleMacKeyDown);
}

function updateMacUI() {
  const img = document.getElementById('mac-viewer-img');
  const counter = document.getElementById('mac-viewer-counter');
  if (img) img.src = macAlbum[macIndex];
  if (counter) counter.innerText = `${macIndex + 1} / ${macAlbum.length}`;
}

window.changeMacImage = function(step) {
  if (macAlbum.length <= 1) return;
  macIndex = (macIndex + step + macAlbum.length) % macAlbum.length;
  const img = document.getElementById('mac-viewer-img');
  img.style.opacity = '0.5';
  updateMacUI();
  setTimeout(() => img.style.opacity = '1', 100);
};

window.closeMacViewer = function() {
  const v = document.getElementById('mac-image-viewer');
  if (v) {
    v.classList.remove('active');
    setTimeout(() => v.style.display = 'none', 300);
  }
  document.removeEventListener('keydown', handleMacKeyDown);
};

function handleMacKeyDown(e) {
  const v = document.getElementById('mac-image-viewer');
  if (v && v.style.display === 'flex') {
    if (e.key === 'ArrowRight') changeMacImage(1);
    if (e.key === 'ArrowLeft') changeMacImage(-1);
    if (e.key === 'Escape') closeMacViewer();
  }
}

// --- 5. æ‹–æ‹½å¼•æ“ ---
let dragObj = null;
let startMouseX, startMouseY, startObjX, startObjY;

document.addEventListener('mousedown', (e) => {
  if (e.target.tagName === 'INPUT') return;
  const handle = e.target.closest('.drag-handle');
  if (!handle) return;
  const target = handle.closest('.app-window') || handle.closest('.icon-unit');
  if (!target || target.classList.contains('is-fullscreen')) return;
  dragObj = target;
  dragObj.style.transition = 'none'; 
  const overlay = dragObj.closest('.window-overlay');
  if (overlay) bringToFront(overlay);
  startMouseX = e.clientX;
  startMouseY = e.clientY;
  startObjX = dragObj.offsetLeft;
  startObjY = dragObj.offsetTop;
  e.preventDefault(); 
});

document.addEventListener('mousemove', (e) => {
  if (!dragObj) return;
  dragObj.style.left = (startObjX + (e.clientX - startMouseX)) + 'px';
  dragObj.style.top = (startObjY + (e.clientY - startMouseY)) + 'px';
  dragObj.style.margin = "0"; 
});

document.addEventListener('mouseup', () => {
  if (dragObj) {
    if (dragObj.classList.contains('app-window')) {
      dragObj.style.transition = 'transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s';
    }
    dragObj = null;
  }
});

// --- 6. è¾…åŠ©åŠŸèƒ½ (æ—¶é’Ÿä¸è¿‡æ»¤) ---
setInterval(() => {
  const clock = document.getElementById('mac-clock');
  if (clock) {
    const now = new Date();
    clock.innerText = now.toLocaleString('zh-CN', {
      year:'numeric', month:'short', day:'numeric', weekday:'short', 
      hour:'2-digit', minute:'2-digit', hour12:false
    }).replace(/\//g,'å¹´');
  }
}, 1000);

let currentCategory = 'all';
window.filterByCategory = function(cat, el) {
  currentCategory = cat;
  document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
  el.classList.add('active');
  filterPosts();
};

window.filterPosts = function() {
  const query = document.getElementById('finder-search')?.value.toLowerCase() || "";
  const items = document.querySelectorAll('.post-item');
  items.forEach(item => {
    const title = item.querySelector('.file-name').innerText.toLowerCase();
    const category = item.querySelector('.file-category').innerText;
    const matchCategory = (currentCategory === 'all' || category === currentCategory);
    const matchSearch = title.includes(query);
    item.style.display = (matchCategory && matchSearch) ? 'flex' : 'none';
  });
};

// æš´éœ²å‡½æ•°ç»™å…¨å±€
window.openWin = openWin;
window.closeWin = closeWin;
window.minWin = minWin;
window.toggleFull = toggleFull;
window.bringToFront = bringToFront;
</script>