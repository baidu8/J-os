---
// IpadView.astro
const { posts } = Astro.props;

// æå–åˆ†ç±»
const categories = posts ? [...new Set(posts.map(post => post.data.category || 'æœªåˆ†ç±»'))] : [];

const getCategoryIcon = (cat) => {
  const icons = { 'æŠ€æœ¯': 'ğŸ’»', 'ç”Ÿæ´»': 'â˜•', 'æ‘„å½±': 'ğŸ“·', 'ä»£ç ': 'âš¡', 'æœªåˆ†ç±»': 'ğŸ“' };
  return icons[cat] || 'ğŸ“';
};
---

<div class="view-ipad">
  <div class="ipad-statusbar">
    <div class="status-left">ä¸­å›½ç§»åŠ¨ <span id="ipad-clock-val">00:00</span></div>
    <div class="ipad-status-icons">ğŸ“¶ Wi-Fi ğŸ”‹ 100%</div>
  </div>

  <div class="ipad-container" id="ipad-main-wrapper">
    <div class="ipad-sidebar">
      <div class="sidebar-header">
        <h1 style="margin: 0 0 15px 0; font-size: 28px;">æ–‡åº“</h1>
        <div class="ipad-search-box">
          <input type="text" id="ipad-search-input" placeholder="æœç´¢æ–‡ç« ..." oninput="filterIpadPostsBySearch()" />
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <div class="nav-item active" id="cat-all" onclick="setIpadCategory('all', this)">ğŸ“‚ æ‰€æœ‰åšæ–‡</div>
        <div class="divider">åˆ†ç±»</div>
        {categories.map(cat => (
          <div class="nav-item" onclick={`setIpadCategory('${cat}', this)`}>
            {getCategoryIcon(cat)} {cat}
          </div>
        ))}
      </nav>
    </div>

    <div class="ipad-main-content">
      <div class="content-header" style="margin-bottom: 25px; display: flex; align-items: center;">
        <button class="sidebar-toggle" onclick="toggleIpadSidebar()" title="åˆ‡æ¢ä¾§è¾¹æ " style="background:none; border:none; color:#007aff; cursor:pointer; padding: 5px; display: flex; align-items: center;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="3" x2="9" y2="21"></line>
          </svg>
        </button>
      </div>

      <div class="ipad-grid" id="ipad-post-list">
        {posts.map(post => (
          <div class="ipad-app-unit" 
               data-category={post.data.category || 'æœªåˆ†ç±»'} 
               data-title={post.data.title.toLowerCase()}
               onclick={`openIpadWin('ipad-post-${post.id}')`}>
            <div class="ipad-app-icon">ğŸ“˜</div>
            <div class="ipad-app-label">{post.data.title}</div>
          </div>
        ))}
      </div>
    </div>
  </div>

  <div class="ipad-dock-fixed">
    <div class="ipad-dock glass">
      <div class="dock-app">ğŸŒ</div>
      <div class="dock-app">ğŸ“·</div>
      <div class="dock-app">ğŸµ</div>
      <div class="dock-divider"></div>
      <div class="dock-app">ğŸ“</div>
    </div>
  </div>

  {posts.map(post => (
    <div class="ipad-overlay" id={`ipad-post-${post.id}`}>
      <div class="ipad-window">
        <div class="ipad-grabber" style="width:36px; height:5px; background:#ddd; border-radius:3px; margin: 10px auto -15px;"></div>
        
        <div class="ipad-window-header">
          <button class="ipad-close-btn" onclick={`closeIpadWin('ipad-post-${post.id}')`}>å®Œæˆ</button>
          <div class="ipad-window-title">æ–‡ç« é¢„è§ˆ</div>
          <div style="width:60px"></div>
        </div>
        <div class="ipad-window-body">
          <article class="ipad-article">
            <h1>{post.data.title}</h1>
            <div class="article-meta">{post.data.date} â€¢ {post.data.category}</div>
            <div class="article-content">
              <post.Content />
            </div>
          </article>
        </div>
      </div>
    </div>
  ))}

<div id="image-viewer" class="image-viewer">
  <div class="viewer-overlay" onclick="closeImageViewer()"></div>
  
  <button class="viewer-prev" onclick="event.stopPropagation(); changeImage(-1)">â®</button>
  
  <img id="viewer-img" src="" alt="é¢„è§ˆå›¾ç‰‡" onclick="handleImageClick(event)" />
  
  <button class="viewer-next" onclick="event.stopPropagation(); changeImage(1)">â¯</button>
  
  <div id="viewer-counter" class="viewer-counter">1 / 1</div>
</div>

<style>
  /* ==========================================
     1. å…¨å±€ä¸å¸ƒå±€å®¹å™¨ (Global & Layout)
     ========================================== */
  .view-ipad {
    height: 100dvh; /* åŠ¨æ€é€‚é…ç§»åŠ¨ç«¯åœ°å€æ  */
    width: 100vw;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    position: relative;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: url('https://images.unsplash.com/photo-1542751371-adc38448a05e?q=80&w=2000') center/cover !important;
    padding-bottom: env(safe-area-inset-bottom);
  }

  .ipad-statusbar {
    height: 35px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 25px;
    color: white;
    font-size: 14px;
    z-index: 10;
  }

  /* ä¸»å®¹å™¨ï¼šé«˜åº¦æ‰£é™¤çŠ¶æ€æ å’Œ Dock ç©ºé—´ */
  .ipad-container {
    display: flex;
    height: calc(100% - 150px);
    margin: 10px 20px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
  }

  /* ==========================================
     2. ä¾§è¾¹æ  (Sidebar)
     ========================================== */
  .ipad-sidebar {
    width: 280px;
    background: rgba(255, 255, 255, 0.85);
    padding: 25px 20px;
    border-right: 1px solid rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 1;
  }

  .sidebar-header h1 { font-size: 30px; font-weight: 700; margin-bottom: 15px; color: #000; }

  /* ä¾§è¾¹æ æŠ˜å é€»è¾‘ */
  .sidebar-hidden .ipad-sidebar {
    width: 0;
    padding: 0;
    margin: 0;
    opacity: 0;
    border-right: none;
    pointer-events: none;
    transform: translateX(-30px);
  }

  /* ä¾§è¾¹æ å¯¼èˆªé¡¹ */
  .nav-item {
    padding: 12px 15px;
    border-radius: 12px;
    margin-bottom: 5px;
    cursor: pointer;
    color: #333;
    transition: 0.2s;
    font-size: 17px;
  }
  .nav-item:hover { background: rgba(0,0,0,0.04); }
  .nav-item.active {
    background: #007aff !important;
    color: white !important;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    width: calc(100% - 20px); /* å·¦å³ç•™ç©º */
    margin-left: 10px;
    margin-right: 10px;
  }

  .divider { font-size: 13px; color: #888; margin: 20px 15px 10px; font-weight: 600; text-transform: uppercase; }

  /* ==========================================
     3. æœç´¢æ¡†ä¸æŒ‰é’® (Search & Controls)
     ========================================== */
  .ipad-search-box { margin-bottom: 20px; }
  .ipad-search-box input {
    width: 100%;
    padding: 10px 15px 10px 35px; /* å·¦ä¾§ç•™å‡ºå›¾æ ‡ç©ºé—´ */
    border-radius: 10px;
    border: 1px solid rgba(0, 0, 0, 0.05);
    background: rgba(0,0,0,0.06);
    outline: none;
    font-size: 16px;
    transition: all 0.2s;
  }
  .ipad-search-box input:focus { background: #fff; box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2); }

  /* åˆ‡æ¢æŒ‰é’® */
  .content-header { padding: 15px 0 0 15px; }
  .sidebar-toggle {
    background: none; border: none; color: #007aff; cursor: pointer;
    padding: 8px; border-radius: 8px; display: flex; align-items: center;
    transition: all 0.3s ease; z-index: 100;
  }
  .sidebar-toggle:hover { background: rgba(0, 122, 255, 0.1); }
  
  .sidebar-hidden .sidebar-toggle {
    filter: drop-shadow(0 0 8px rgba(0, 122, 255, 0.5));
    transform: scale(1.1);
  }

  /* ==========================================
     4. å†…å®¹ç½‘æ ¼ä¸å›¾æ ‡ (Grid & Apps)
     ========================================== */
  .ipad-main-content { flex: 1; padding: 20px 35px 35px; overflow-y: auto; transition: padding 0.4s ease; }
  .ipad-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 35px; }

  .ipad-app-unit {
    display: flex; flex-direction: column; align-items: center; cursor: pointer;
    transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    -webkit-tap-highlight-color: transparent;
  }
  .ipad-app-unit:hover { transform: translateY(-5px); }
  .ipad-app-unit:active { transform: scale(0.9); }

  .ipad-app-icon {
    width: 90px; height: 90px; background: white; border-radius: 20px;
    display: flex; align-items: center; justify-content: center; font-size: 45px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.15); border: 0.5px solid rgba(0,0,0,0.1);
  }
  .ipad-app-label {
    margin-top: 12px; font-size: 15px; color: white; text-align: center;
    text-shadow: 0 2px 5px rgba(0,0,0,0.5); font-weight: 500;
    max-width: 100px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  }

  /* ==========================================
     5. Dock æ  (Fixed Dock)
     ========================================== */
  .ipad-dock-fixed {
    position: absolute; left: 0; width: 100%; display: flex; justify-content: center; 
    pointer-events: none; z-index: 1000;
    bottom: calc(25px + env(safe-area-inset-bottom));
  }

  .ipad-dock {
    display: flex; padding: 12px 20px; pointer-events: auto; gap: 15px;
    background: rgba(255, 255, 255, 0.25) !important;
    backdrop-filter: blur(30px) saturate(180%);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    border-radius: 28px; border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); transition: all 0.3s ease;
  }

  .dock-app {
    width: 60px; height: 60px; background: white; border-radius: 14px;
    display: flex; align-items: center; justify-content: center; font-size: 32px;
    cursor: pointer; transition: 0.2s;
  }
  .dock-app:hover { transform: scale(1.1) translateY(-10px); }
  .dock-divider { width: 1px; height: 45px; background: rgba(0,0,0,0.1); align-self: center; }

  /* ==========================================
     6. è¯¦æƒ…å¼¹çª— (Article Window)
     ========================================== */
  .ipad-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 3000; }
  .ipad-overlay.active { display: flex; }

  .ipad-window { width: 80%; height: 85%; background: white; border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
  .ipad-grabber { width: 40px; height: 5px; background: rgba(0, 0, 0, 0.1); border-radius: 10px; margin: 12px auto 0; flex-shrink: 0; }
  
  .ipad-window-header { height: 60px; border-bottom: 1px solid #eee; display: flex; align-items: center; padding: 0 20px; background: #f9f9f9; }
  .ipad-close-btn { color: #007aff; border: none; background: none; font-size: 18px; font-weight: 600; cursor: pointer; }
  .ipad-window-title { flex: 1; text-align: center; font-weight: 600; }
  .ipad-window-body { flex: 1; padding: 40px; overflow-y: auto; }

  .ipad-article h1 { font-size: 36px; margin-bottom: 10px; font-weight: 700; }
  .article-meta { color: #888; margin-bottom: 30px; font-size: 16px; }
  .article-content { line-height: 1.8; font-size: 19px; color: #333; }
  .article-content :global(img) { max-width: 100%; border-radius: 12px; margin: 20px 0; }
  .image-viewer {
  position: fixed; inset: 0; z-index: 9999;
  display: none; justify-content: center; align-items: center;
  background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px); opacity: 0; transition: opacity 0.3s ease;
}
.image-viewer.active { display: flex; opacity: 1; }

.viewer-overlay { position: absolute; inset: 0; cursor: zoom-out; z-index: 1; }

.image-viewer img {
  max-width: 90%; max-height: 90%; border-radius: 8px;
  transform: scale(0.9); transition: transform 0.3s ease;
  cursor: pointer; z-index: 10; position: relative;
}
.image-viewer.active img { transform: scale(1); }

/* ç§»é™¤ä¹‹å‰çš„ .viewer-close-x ç›¸å…³æ ·å¼ï¼Œæ›¿æ¢ä¸ºä»¥ä¸‹å†…å®¹ */

.viewer-prev, .viewer-next {
  position: absolute; 
  top: 50%; 
  transform: translateY(-50%);
  background: rgba(255, 255, 255, 0.15); /* å¢åŠ åŠé€æ˜åº•è‰² */
  backdrop-filter: blur(5px);
  border: none; 
  color: white;
  width: 50px; 
  height: 50px; 
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px; /* åœ†è§’æ›´åƒ iPad */
  font-size: 24px; 
  cursor: pointer;
  transition: all 0.2s;
  z-index: 20;
}

.viewer-prev:hover, .viewer-next:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-50%) scale(1.1);
}

.viewer-prev { left: 30px; }
.viewer-next { right: 30px; }

/* é¡µç è®¡æ•°å™¨ä½ç½®å¾®è°ƒï¼Œé¿å…æŒ¡ä½å›¾ç‰‡ */
.viewer-counter {
  position: absolute;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  color: rgba(255,255,255,0.9);
  background: rgba(0, 0, 0, 0.4);
  padding: 6px 16px;
  border-radius: 20px;
  font-size: 14px;
  z-index: 20;
  letter-spacing: 1px;
}
.viewer-prev { left: 20px; top: 50%; transform: translateY(-50%); background: none; border: none; color: white; font-size: 40px; cursor: pointer; }
.viewer-next { right: 20px; top: 50%; transform: translateY(-50%); background: none; border: none; color: white; font-size: 40px; cursor: pointer; }
.viewer-counter { bottom: 40px; color: white; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 14px; }
</style>

<script is:inline>
let currentAlbum = [];
  let currentIndex = 0;

  // åˆå§‹åŒ–é¢„è§ˆï¼šç‚¹å‡»æ­£æ–‡å›¾ç‰‡
  document.addEventListener('click', function(e) {
    if (e.target.tagName === 'IMG' && e.target.closest('.article-content')) {
      const article = e.target.closest('.article-content');
      const imgs = Array.from(article.querySelectorAll('img'));
      currentAlbum = imgs.map(img => img.src);
      currentIndex = currentAlbum.indexOf(e.target.src);
      
      showViewer();
    }
  });

  function showViewer() {
    const viewer = document.getElementById('image-viewer');
    updateViewerUI();
    viewer.style.display = 'flex';
    setTimeout(() => viewer.classList.add('active'), 10);
  }

  function updateViewerUI() {
    document.getElementById('viewer-img').src = currentAlbum[currentIndex];
    document.getElementById('viewer-counter').innerText = `${currentIndex + 1} / ${currentAlbum.length}`;
    // å¦‚æœåªæœ‰ä¸€å¼ å›¾ï¼Œéšè—ç®­å¤´
    const showBtns = currentAlbum.length > 1 ? 'block' : 'none';
    document.querySelector('.viewer-prev').style.display = showBtns;
    document.querySelector('.viewer-next').style.display = showBtns;
  }

  // ç‚¹å‡»å›¾ç‰‡çš„å¤„ç†
  window.handleImageClick = function(e) {
    e.stopPropagation(); // é˜»æ­¢è§¦å‘åº•å±‚çš„å…³é—­
    if (currentAlbum.length > 1) {
      changeImage(1); // å¤šå›¾åˆ™åˆ‡ä¸‹ä¸€å¼ 
    } else {
      closeImageViewer(); // å•å›¾åˆ™ç›´æ¥å…³
    }
  };

  window.changeImage = function(step) {
    currentIndex = (currentIndex + step + currentAlbum.length) % currentAlbum.length;
    const img = document.getElementById('viewer-img');
    img.style.opacity = '0';
    setTimeout(() => {
      updateViewerUI();
      img.style.opacity = '1';
    }, 150);
  };

  window.closeImageViewer = function() {
    const viewer = document.getElementById('image-viewer');
    if (viewer) {
      viewer.classList.remove('active');
      setTimeout(() => { viewer.style.display = 'none'; }, 300);
    }
  };
  // 1. æ–°å¢ï¼šä¾§è¾¹æ æŠ˜å åˆ‡æ¢å‡½æ•°
  window.toggleIpadSidebar = function() {
    const wrapper = document.getElementById('ipad-main-wrapper');
    if (wrapper) {
      wrapper.classList.toggle('sidebar-hidden');
    }
  };

  // 2. çª—å£æ‰“å¼€å‡½æ•°
  window.openIpadWin = function(id) {
    const el = document.getElementById(id);
    if(el) {
      el.style.display = 'flex';
      setTimeout(() => el.classList.add('active'), 10);
    }
  };

  // 3. çª—å£å…³é—­å‡½æ•°
  window.closeIpadWin = function(id) {
    const el = document.getElementById(id);
    if(el) {
      el.classList.remove('active');
      setTimeout(() => el.style.display = 'none', 300);
    }
  };

  // 4. åˆ†ç±»è®¾ç½®é€»è¾‘
  window.setIpadCategory = function(cat, el) {
    // åˆ‡æ¢é«˜äº®
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    el.classList.add('active');
    
    // æ‰§è¡Œæœç´¢/è¿‡æ»¤é€»è¾‘
    window.currentIpadCategory = cat;
    filterIpadPostsByAll();
  };

  // 5. ç»¼åˆè¿‡æ»¤é€»è¾‘ï¼ˆæœç´¢ + åˆ†ç±»ï¼‰
  window.filterIpadPostsBySearch = function() {
    filterIpadPostsByAll();
  };

  window.filterIpadPostsByAll = function() {
    const query = document.getElementById('ipad-search-input').value.toLowerCase().trim();
    const items = document.querySelectorAll('#ipad-post-list .ipad-app-unit');
    const cat = window.currentIpadCategory || 'all';
    
    items.forEach(item => {
      const itemCat = item.getAttribute('data-category');
      const itemTitle = item.getAttribute('data-title');
      const matchCat = (cat === 'all' || itemCat === cat);
      const matchSearch = itemTitle.includes(query);
      
      item.style.display = (matchCat && matchSearch) ? 'flex' : 'none';
    });
  };

  // 6. æ—¶é—´æ›´æ–°
  function updateIpadTime() {
    const clock = document.getElementById('ipad-clock-val');
    if(clock) {
      const now = new Date();
      clock.innerText = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
    }
  }
  setInterval(updateIpadTime, 1000);
  updateIpadTime();
</script>