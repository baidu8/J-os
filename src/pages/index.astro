---
/**
 * index.astro - ä¸‰ç«¯åšå®¢ä¸­æ§é¡µé¢ (å·²ä¼˜åŒ–ç§»åŠ¨ç«¯å…¨å±å¹¶æ”¯æŒæ­£æ–‡æ¸²æŸ“)
 */
import { getCollection } from 'astro:content';

import MacView from '../components/MacView.astro';
import IpadView from '../components/IpadView.astro';
import IphoneView from '../components/IphoneView.astro';

const allPosts = await getCollection('blog');

// æå–åˆ†ç±»
const categories = [...new Set(allPosts.map(post => post.data.category || 'æœªåˆ†ç±»'))];

// --- æ ¸å¿ƒä¿®æ”¹ï¼šæ¸²æŸ“ Markdown å†…å®¹ ---
const posts = await Promise.all(
  allPosts
    .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
    .map(async (post) => {
      const { Content } = await post.render(); // è¿™ä¸€æ­¥æ˜¯å…³é”®ï¼Œè§£æ Markdown
      return {
        id: post.slug,
        data: post.data,
        body: post.body,
        slug: post.slug,
        Content: Content // å°†æ¸²æŸ“åçš„ç»„ä»¶ä¼ é€’ç»™å­é¡µé¢
      };
    })
);

const pageTitle = "J-OS";
---

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="J-OS" />
    <meta name="mobile-web-app-capable" content="yes" />
    
    <style is:global>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      html, body {
        width: 100%;
        /* 3. å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ 100svh ç¡®ä¿åœ¨æ‰€æœ‰æ‰‹æœºæµè§ˆå™¨ä¸­ä¸è¢«æŒ¡ä½åº•éƒ¨ */
        height: 100vh;
        height: 100svh; 
        overflow: hidden;
        background-color: #000;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        
        /* ç¦æ­¢é•¿æŒ‰å¼¹å‡ºèœå•ï¼Œæ›´åƒåŸç”ŸApp */
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }

      .os-view {
        display: none;
        width: 100vw;
        height: 100vh;
        height: 100svh;
      }

      /* ç¡®ä¿å¼¹çª—å†…çš„å›¾ç‰‡æ°¸è¿œä¸ä¼šè¶…è¿‡çˆ¶çº§å®½åº¦ */
.modal-content img, 
.post-content img {
  max-width: 100%;    /* å®½åº¦æœ€å¤§ç­‰äºçˆ¶å®¹å™¨ */
  height: auto;       /* é«˜åº¦æŒ‰æ¯”ä¾‹è‡ªåŠ¨ç¼©æ”¾ï¼Œä¸æ‹‰ä¼¸ */
  display: block;     /* æ¶ˆé™¤å›¾ç‰‡åº•éƒ¨çš„å¾®å°ç©ºéš™ */
  border-radius: 8px; /* ç»™æ–‡ç« å›¾ç‰‡ä¹ŸåŠ ä¸€ç‚¹åœ†è§’ï¼Œæ›´ç¬¦åˆ iOS å®¡ç¾ */
  margin: 10px auto;  /* å±…ä¸­æ˜¾ç¤º */
  object-fit: contain; /* ç¡®ä¿å›¾ç‰‡å®Œæ•´æ˜¾ç¤ºåœ¨åŒºåŸŸå†… */
}
.iphone-full-page {
  /* ...ä½ ä¹‹å‰çš„æ ·å¼... */
  overflow-y: auto;   /* å…è®¸ä¸Šä¸‹æ»šåŠ¨ */
  overflow-x: hidden; /* ç»å¯¹ç¦æ­¢æ¨ªå‘æº¢å‡º */
  display: flex;
  flex-direction: column;
}
/* é’ˆå¯¹æ–‡ç« å†…å®¹çš„ç‰¹æ®Šå¤„ç† */
.post-body {
  word-wrap: break-word; /* é˜²æ­¢é•¿å­—æ¯/ä»£ç æ’‘ç ´å¼¹çª— */
  overflow-wrap: break-word;
}

.post-body img {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* ç»™å›¾ç‰‡åŠ ç‚¹é˜´å½±ï¼Œæ›´æœ‰å±‚æ¬¡æ„Ÿ */
}

      /* ç§»åŠ¨ç«¯ (iPhone) */
      @media (max-width: 767px) {
        #iphone-view { 
          display: block; 
          /* 4. å…³é”®æ–°å¢ï¼šå¤„ç† iOS å®‰å…¨åŒºåŸŸï¼ˆé¿å¼€åˆ˜æµ·å’Œåº•éƒ¨æ¨ªæ¡ï¼‰ */
          padding-top: env(safe-area-inset-top);
          padding-bottom: env(safe-area-inset-bottom);
        }
      }

      /* å¹³æ¿ç«¯ (iPad) */
      @media (min-width: 768px) and (max-width: 1024px) {
        #ipad-view { display: block; }
      }

      /* ç”µè„‘ç«¯ (Mac) */
      @media (min-width: 1025px) {
        #mac-view { display: block; }
      }
    </style>
  </head>
  <body>

    <div id="iphone-view" class="os-view">
      <IphoneView posts={posts} />
    </div>

    <div id="ipad-view" class="os-view">
      <IpadView posts={posts} />
    </div>

    <div id="mac-view" class="os-view">
      <MacView posts={posts} categories={categories} />
    </div>

    <script src="/notes.js" is:inline></script>
    <script src="/messages.js" is:inline></script>
    <script is:inline>
      // å› ä¸ºä½ çš„ notes.js é‡Œé¢æ˜¯ç”¨ getElementById('notes-textarea')
      // è€Œä¸‰ç«¯æ¸²æŸ“åœ¨åŒä¸€ä¸ª HTML é‡Œï¼Œä¼šå‡ºç° ID é‡å¤çš„æƒ…å†µã€‚
      // æˆ‘ä»¬ç”¨è¿™æ®µå°ä»£ç è®© JS èƒ½å¤ŸåŒæ—¶æ“ä½œä¸‰ä¸ªè§†å›¾é‡Œçš„è¾“å…¥æ¡†ã€‚
      
      document.addEventListener('input', (e) => {
        if (e.target.id === 'notes-textarea') {
          // å½“ä½ åœ¨ä¸€ç«¯è¾“å…¥æ—¶ï¼Œè‡ªåŠ¨åŒæ­¥åˆ°å¦å¤–ä¸¤ç«¯çš„è¾“å…¥æ¡†
          const allTextareas = document.querySelectorAll('#notes-textarea');
          allTextareas.forEach(el => {
            if (el !== e.target) el.value = e.target.value;
          });
        }
      });
      
  // --- 7. ç›¸å†Œæ ¸å¿ƒè¡¥ä¸ ---
  function initPhotoSidebar() {
    const sidebarList = document.getElementById('photos-post-links');
    if (!sidebarList) return;
  
    const photoPosts = Array.from(document.querySelectorAll('.post-item')).filter(item => {
      return item.querySelector('.file-category')?.innerText === 'æ‘„å½±';
    });
  
    sidebarList.innerHTML = photoPosts.map(post => {
      const title = post.querySelector('.file-name').innerText;
      const winId = post.getAttribute('onclick').match(/'([^']+)'/)[1];
      return `
        <div class="sidebar-item" onclick="loadAlbumFromPost('${winId}', '${title}', this)">
          ğŸ“¸ ${title}
        </div>
      `;
    }).join('');
  
    // ã€ä¼˜åŒ–ã€‘ï¼šé»˜è®¤åŠ è½½æœ€æ–°ä¸€ç¯‡
    const firstItem = sidebarList.querySelector('.sidebar-item');
    if (firstItem) {
      firstItem.click();
    }
  }
  
  window.loadAlbumFromPost = function(winId, title, el) {
    document.querySelectorAll('#photos-post-links .sidebar-item').forEach(i => i.classList.remove('active'));
    if (el) el.classList.add('active');
  
    const headerTitle = document.querySelector('.photos-header h2');
    const headerStats = document.querySelector('.photos-header p');
    if (headerTitle) headerTitle.innerText = title;
  
    const postWin = document.getElementById(winId);
    const photoGrid = document.querySelector('.photos-grid');
    
    if (!postWin || !photoGrid) return;
  
    const imgs = Array.from(postWin.querySelectorAll('.image-grid-folder img'));
  
    if (imgs.length === 0) {
      photoGrid.innerHTML = '<div style="grid-column:1/-1; padding:40px; color:#999; text-align:center;">è¯¥åšæ–‡ä¸­æ²¡æœ‰ç½‘æ ¼å›¾ç‰‡</div>';
      if (headerStats) headerStats.innerText = '0 å¼ ç…§ç‰‡';
      return;
    }
  
    if (headerStats) headerStats.innerText = `${imgs.length} å¼ ç…§ç‰‡`;
    // å…³é”®ï¼šç‚¹å‡»å¡ç‰‡è°ƒç”¨é¢„è§ˆ
    photoGrid.innerHTML = imgs.map((img, idx) => `
      <div class="photo-card" onclick="openMacViewerFromAlbum('${winId}', ${idx})">
        <img src="${img.src}" />
      </div>
    `).join('');
  };
  
  // ã€ä¿®å¤ã€‘ï¼šç›¸å†Œä¸“ç”¨é¢„è§ˆå‡½æ•°
  window.openMacViewerFromAlbum = function(winId, index) {
    const postWin = document.getElementById(winId);
    if (!postWin) return;
    const imgs = Array.from(postWin.querySelectorAll('.image-grid-folder img')).map(i => i.src);
    
    macAlbum = imgs;
    macIndex = index;
    openMacViewer();
  };
  
  document.addEventListener('DOMContentLoaded', initPhotoSidebar);
  setTimeout(initPhotoSidebar, 1000);
    </script>
  </body>
</html>